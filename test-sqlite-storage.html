<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQLite Storage Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #3b82f6;
      padding-bottom: 10px;
    }
    h2 {
      color: #666;
      margin-top: 30px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #3b82f6;
      border-radius: 4px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #ef4444;
    }
    .danger:hover {
      background: #dc2626;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 20px;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #3b82f6;
      margin-top: 5px;
    }
    .comparison {
      background: #fef3c7;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #f59e0b;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’¾ SQLite Storage Test</h1>
    
    <div class="comparison">
      <strong>SQLite vs LocalStorage:</strong><br>
      â€¢ LocalStorage: ~5-10MB Limit<br>
      â€¢ SQLite: Praktisch unbegrenzt (nur durch localStorage-Serialisierung limitiert)<br>
      â€¢ SQLite: Schnellere Queries durch Indexe<br>
      â€¢ SQLite: Strukturierte Datenbank mit SQL-Queries
    </div>

    <div class="test-section">
      <h2>Initialization</h2>
      <button id="initSQLite">Initialize SQLite Plugin</button>
      <button id="initLocalStorage">Initialize LocalStorage Plugin (Compare)</button>
    </div>

    <div class="test-section">
      <h2>Storage Operations</h2>
      <button id="save10">Save 10 Events</button>
      <button id="save100">Save 100 Events</button>
      <button id="save1000">Save 1000 Events</button>
      <button id="queryAll">Query All Events</button>
      <button id="queryKind">Query by Kind</button>
      <button id="queryAuthor">Query by Author</button>
      <button id="clearStorage" class="danger">Clear Storage</button>
    </div>

    <div class="test-section">
      <h2>Performance Tests</h2>
      <button id="perfSave">Performance: Save 500 Events</button>
      <button id="perfQuery">Performance: Query Events</button>
      <button id="comparePlugins">Compare SQLite vs LocalStorage</button>
    </div>

    <div class="test-section">
      <h2>Relay Sync</h2>
      <button id="syncFromRelay">Sync from relay-rpi.edufeed.org</button>
      <button id="autoSync">Enable Auto-Sync (60s)</button>
      <button id="stopAutoSync">Stop Auto-Sync</button>
    </div>

    <h2>Statistics</h2>
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-label">Events Stored</div>
        <div class="stat-value" id="eventCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Storage Size (KB)</div>
        <div class="stat-value" id="storageSize">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Storage Size (MB)</div>
        <div class="stat-value" id="storageSizeMB">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Last Operation</div>
        <div class="stat-value" id="lastOp" style="font-size: 14px;">-</div>
      </div>
    </div>

    <h2>Console Output</h2>
    <div id="output"></div>
  </div>

  <script type="module">
    import { StorageManager } from './framework/core/StorageManager.js';
    import { SQLitePlugin } from './framework/plugins/storage/SQLitePlugin.js';
    import { LocalStoragePlugin } from './framework/plugins/storage/LocalStoragePlugin.js';
    import { NostrFramework } from './framework/index.js';

    const output = document.getElementById('output');
    let manager = null;
    let currentPlugin = null;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    async function updateStats() {
      if (!manager) return;
      try {
        const stats = await manager.getStats();
        document.getElementById('eventCount').textContent = stats.eventCount;
        document.getElementById('storageSize').textContent = stats.approximateSizeKB;
        document.getElementById('storageSizeMB').textContent = stats.approximateSizeMB || 0;
      } catch (error) {
        log(`Failed to update stats: ${error.message}`, 'error');
      }
    }

    function createTestEvents(count, kindVariety = true) {
      const events = [];
      const kinds = kindVariety ? [1, 3, 7, 30023] : [1];
      const authors = ['author1', 'author2', 'author3'];
      
      for (let i = 0; i < count; i++) {
        events.push({
          id: `test_${Date.now()}_${i}_${Math.random()}`,
          kind: kinds[i % kinds.length],
          pubkey: authors[i % authors.length],
          content: `Test event ${i} - ${new Date().toISOString()} - Lorem ipsum dolor sit amet, consectetur adipiscing elit.`,
          tags: [
            ['t', 'test'],
            ['p', `user${i % 10}`],
            ['e', `event${i % 5}`]
          ],
          created_at: Math.floor(Date.now() / 1000) - (i * 60),
          sig: 'dummy_signature_' + i
        });
      }
      return events;
    }

    // Initialization
    document.getElementById('initSQLite').addEventListener('click', async () => {
      try {
        log('=== Initializing SQLite Plugin ===', 'info');
        manager = new StorageManager();
        currentPlugin = new SQLitePlugin({ dbName: 'nostr_sqlite_test' });
        
        const start = performance.now();
        await manager.initialize(currentPlugin);
        const duration = performance.now() - start;
        
        log(`âœ“ SQLite Plugin initialized in ${duration.toFixed(2)}ms`, 'success');
        await updateStats();
      } catch (error) {
        log(`âœ— Initialization failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    document.getElementById('initLocalStorage').addEventListener('click', async () => {
      try {
        log('=== Initializing LocalStorage Plugin ===', 'info');
        manager = new StorageManager();
        currentPlugin = new LocalStoragePlugin({ keyPrefix: 'compare_' });
        
        const start = performance.now();
        await manager.initialize(currentPlugin);
        const duration = performance.now() - start;
        
        log(`âœ“ LocalStorage Plugin initialized in ${duration.toFixed(2)}ms`, 'success');
        await updateStats();
      } catch (error) {
        log(`âœ— Initialization failed: ${error.message}`, 'error');
      }
    });

    // Save operations
    document.getElementById('save10').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      const events = createTestEvents(10);
      log(`Saving ${events.length} events...`, 'info');
      const start = performance.now();
      const count = await manager.save(events);
      const duration = performance.now() - start;
      log(`âœ“ Saved ${count} events in ${duration.toFixed(2)}ms`, 'success');
      document.getElementById('lastOp').textContent = 'Save 10';
      await updateStats();
    });

    document.getElementById('save100').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      const events = createTestEvents(100);
      log(`Saving ${events.length} events...`, 'info');
      const start = performance.now();
      const count = await manager.save(events);
      const duration = performance.now() - start;
      log(`âœ“ Saved ${count} events in ${duration.toFixed(2)}ms (${(duration/count).toFixed(2)}ms per event)`, 'success');
      document.getElementById('lastOp').textContent = 'Save 100';
      await updateStats();
    });

    document.getElementById('save1000').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      log('Saving 1000 events... This may take a moment...', 'info');
      const events = createTestEvents(1000);
      const start = performance.now();
      const count = await manager.save(events);
      const duration = performance.now() - start;
      log(`âœ“ Saved ${count} events in ${duration.toFixed(2)}ms (${(duration/count).toFixed(2)}ms per event)`, 'success');
      document.getElementById('lastOp').textContent = 'Save 1000';
      await updateStats();
    });

    // Query operations
    document.getElementById('queryAll').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      log('Querying all events...', 'info');
      const start = performance.now();
      const events = await manager.query([]);
      const duration = performance.now() - start;
      log(`âœ“ Found ${events.length} events in ${duration.toFixed(2)}ms`, 'success');
      document.getElementById('lastOp').textContent = 'Query All';
    });

    document.getElementById('queryKind').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      log('Querying events with kind=1...', 'info');
      const start = performance.now();
      const events = await manager.query([{ kinds: [1] }]);
      const duration = performance.now() - start;
      log(`âœ“ Found ${events.length} kind=1 events in ${duration.toFixed(2)}ms`, 'success');
      document.getElementById('lastOp').textContent = 'Query Kind';
    });

    document.getElementById('queryAuthor').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      log('Querying events by author1...', 'info');
      const start = performance.now();
      const events = await manager.query([{ authors: ['author1'] }]);
      const duration = performance.now() - start;
      log(`âœ“ Found ${events.length} events from author1 in ${duration.toFixed(2)}ms`, 'success');
      document.getElementById('lastOp').textContent = 'Query Author';
    });

    document.getElementById('clearStorage').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      if (!confirm('Clear all storage? This cannot be undone.')) return;
      log('Clearing storage...', 'warning');
      await manager.clear();
      log('âœ“ Storage cleared', 'success');
      document.getElementById('lastOp').textContent = 'Clear';
      await updateStats();
    });

    // Performance tests
    document.getElementById('perfSave').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      log('=== Performance Test: Save 500 Events ===', 'info');
      const events = createTestEvents(500);
      const start = performance.now();
      const count = await manager.save(events);
      const duration = performance.now() - start;
      log(`Plugin: ${currentPlugin.name}`, 'info');
      log(`Saved: ${count} events`, 'success');
      log(`Total Time: ${duration.toFixed(2)}ms`, 'success');
      log(`Per Event: ${(duration/count).toFixed(2)}ms`, 'success');
      log(`Events/sec: ${(count/(duration/1000)).toFixed(0)}`, 'success');
      await updateStats();
    });

    document.getElementById('perfQuery').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      log('=== Performance Test: Query Events ===', 'info');
      
      const start1 = performance.now();
      const all = await manager.query([]);
      const dur1 = performance.now() - start1;
      
      const start2 = performance.now();
      const byKind = await manager.query([{ kinds: [1] }]);
      const dur2 = performance.now() - start2;
      
      const start3 = performance.now();
      const byAuthor = await manager.query([{ authors: ['author1'] }]);
      const dur3 = performance.now() - start3;
      
      log(`Plugin: ${currentPlugin.name}`, 'info');
      log(`Query All (${all.length} events): ${dur1.toFixed(2)}ms`, 'success');
      log(`Query by Kind (${byKind.length} events): ${dur2.toFixed(2)}ms`, 'success');
      log(`Query by Author (${byAuthor.length} events): ${dur3.toFixed(2)}ms`, 'success');
    });

    document.getElementById('comparePlugins').addEventListener('click', async () => {
      log('=== Comparing SQLite vs LocalStorage ===', 'info');
      
      // Test SQLite
      log('Testing SQLite...', 'info');
      const sqliteManager = new StorageManager();
      const sqlitePlugin = new SQLitePlugin({ dbName: 'comparison_sqlite' });
      await sqliteManager.initialize(sqlitePlugin);
      
      const events = createTestEvents(200);
      
      const sqliteSaveStart = performance.now();
      await sqliteManager.save(events);
      const sqliteSaveDur = performance.now() - sqliteSaveStart;
      
      const sqliteQueryStart = performance.now();
      const sqliteResults = await sqliteManager.query([{ kinds: [1] }]);
      const sqliteQueryDur = performance.now() - sqliteQueryStart;
      
      await sqliteManager.clear();
      
      // Test LocalStorage
      log('Testing LocalStorage...', 'info');
      const localManager = new StorageManager();
      const localPlugin = new LocalStoragePlugin({ keyPrefix: 'comparison_local_' });
      await localManager.initialize(localPlugin);
      
      const localSaveStart = performance.now();
      await localManager.save(events);
      const localSaveDur = performance.now() - localSaveStart;
      
      const localQueryStart = performance.now();
      const localResults = await localManager.query([{ kinds: [1] }]);
      const localQueryDur = performance.now() - localQueryStart;
      
      await localManager.clear();
      
      // Results
      log('\n=== COMPARISON RESULTS ===', 'info');
      log(`Save 200 Events:`, 'info');
      log(`  SQLite: ${sqliteSaveDur.toFixed(2)}ms`, 'success');
      log(`  LocalStorage: ${localSaveDur.toFixed(2)}ms`, 'success');
      log(`  Winner: ${sqliteSaveDur < localSaveDur ? 'SQLite' : 'LocalStorage'} (${Math.abs(sqliteSaveDur - localSaveDur).toFixed(2)}ms faster)`, 'warning');
      
      log(`\nQuery by Kind:`, 'info');
      log(`  SQLite: ${sqliteQueryDur.toFixed(2)}ms (${sqliteResults.length} results)`, 'success');
      log(`  LocalStorage: ${localQueryDur.toFixed(2)}ms (${localResults.length} results)`, 'success');
      log(`  Winner: ${sqliteQueryDur < localQueryDur ? 'SQLite' : 'LocalStorage'} (${Math.abs(sqliteQueryDur - localQueryDur).toFixed(2)}ms faster)`, 'warning');
    });

    // Relay sync
    document.getElementById('syncFromRelay').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      try {
        log('=== Syncing from relay-rpi.edufeed.org ===', 'info');
        
        const nostr = new NostrFramework({
          relays: ['wss://relay-rpi.edufeed.org'],
          storage: currentPlugin,
          debug: false
        });
        
        await nostr.initialize();
        log('âœ“ Framework initialized', 'success');
        
        log('Fetching events from relay...', 'info');
        const result = await nostr.storage.sync({
          filters: [{ kinds: [1], limit: 50 }]
        });
        
        log(`âœ“ Sync completed: ${result.saved}/${result.total} events saved`, 'success');
        
        // Update our manager reference
        manager = nostr.storage;
        await updateStats();
        
      } catch (error) {
        log(`âœ— Sync failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    let autoSyncInterval = null;
    
    document.getElementById('autoSync').addEventListener('click', async () => {
      if (!manager) { log('Please initialize a plugin first', 'warning'); return; }
      if (autoSyncInterval) {
        log('Auto-sync already running', 'warning');
        return;
      }
      
      log('âœ“ Auto-sync enabled (every 60 seconds)', 'success');
      
      autoSyncInterval = setInterval(async () => {
        try {
          log('Auto-syncing...', 'info');
          const result = await manager.sync({
            filters: [{ kinds: [1], limit: 20 }]
          });
          log(`âœ“ Auto-sync: ${result.saved} new events`, 'success');
          await updateStats();
        } catch (error) {
          log(`âœ— Auto-sync failed: ${error.message}`, 'error');
        }
      }, 60000);
    });

    document.getElementById('stopAutoSync').addEventListener('click', () => {
      if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
        autoSyncInterval = null;
        log('âœ“ Auto-sync stopped', 'success');
      } else {
        log('Auto-sync not running', 'warning');
      }
    });

    // Initialize on load
    log('=== SQLite Storage Test Ready ===', 'success');
    log('Click "Initialize SQLite Plugin" to begin', 'info');
  </script>
</body>
</html>