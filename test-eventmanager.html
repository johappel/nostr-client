<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EventManager Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
      font-size: 1.2em;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 5px 0;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .output pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 0.9em;
      color: #666;
    }
    .stat-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .event-display {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      border: 1px solid #e5e7eb;
    }
    .event-display pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ EventManager Test Suite</h1>
    <p class="subtitle">Orchestration von Event-Erstellung, Signierung und Publishing</p>

    <!-- Test 1: Unit Tests -->
    <div class="test-section">
      <h2>Test 1: Unit Test Suite</h2>
      <button onclick="runUnitTests()">Run Unit Tests</button>
      <div id="unit-output" class="output" style="display:none;">
        <pre id="unit-results"></pre>
      </div>
    </div>

    <!-- Test 2: Event Creation -->
    <div class="test-section">
      <h2>Test 2: Event Erstellung & Signierung</h2>
      <button onclick="testEventCreation()">Create & Sign Event</button>
      <button onclick="testCreateMultiple()">Create Multiple Events</button>
      <div id="creation-output" class="output" style="display:none;">
        <pre id="creation-results"></pre>
      </div>
      <div id="event-display"></div>
    </div>

    <!-- Test 3: Event Publishing -->
    <div class="test-section">
      <h2>Test 3: Event Publishing</h2>
      <button onclick="testPublishing()">Create & Publish Event</button>
      <button onclick="testPublishExisting()">Publish Existing Event</button>
      <div id="publish-output" class="output" style="display:none;">
        <pre id="publish-results"></pre>
      </div>
    </div>

    <!-- Test 4: Event Queries -->
    <div class="test-section">
      <h2>Test 4: Event Queries</h2>
      <button onclick="testQuery()">Query Recent Events</button>
      <button onclick="testQueryFiltered()">Query Filtered Events</button>
      <div id="query-output" class="output" style="display:none;">
        <pre id="query-results"></pre>
      </div>
    </div>

    <!-- Test 5: Subscriptions -->
    <div class="test-section">
      <h2>Test 5: Event Subscriptions</h2>
      <button onclick="testSubscription()">Subscribe to Events</button>
      <button onclick="stopSubscription()">Stop Subscription</button>
      <div id="sub-output" class="output" style="display:none;">
        <pre id="sub-results"></pre>
      </div>
    </div>

    <!-- Test 6: Event Parsing -->
    <div class="test-section">
      <h2>Test 6: Event Parsing</h2>
      <button onclick="testParsing()">Parse Event</button>
      <div id="parse-output" class="output" style="display:none;">
        <pre id="parse-results"></pre>
      </div>
    </div>

    <!-- Test 7: Cache Management -->
    <div class="test-section">
      <h2>Test 7: Cache Management</h2>
      <button onclick="testCache()">Test Cache</button>
      <button onclick="showCacheStats()">Show Cache Stats</button>
      <button onclick="clearEventCache()">Clear Cache</button>
      <div id="cache-output" class="output" style="display:none;">
        <pre id="cache-results"></pre>
      </div>
      <div id="cache-stats" class="stats" style="display:none;"></div>
    </div>

    <!-- Test 8: Event Deletion -->
    <div class="test-section">
      <h2>Test 8: Event Deletion</h2>
      <button onclick="testDeletion()">Create & Delete Event</button>
      <div id="delete-output" class="output" style="display:none;">
        <pre id="delete-results"></pre>
      </div>
    </div>

    <!-- Test 9: Event Bus Integration -->
    <div class="test-section">
      <h2>Test 9: Event Bus Events</h2>
      <button onclick="testEventBusIntegration()">Test Event Bus</button>
      <div id="eventbus-output" class="output" style="display:none;">
        <pre id="eventbus-results"></pre>
      </div>
    </div>
  </div>

  <script type="module">
    import { EventManager } from './framework/core/EventManager.js';
    import { TemplateEngine } from './framework/core/TemplateEngine.js';
    import { SignerManager } from './framework/core/SignerManager.js';
    import { RelayManager } from './framework/core/RelayManager.js';
    import { MockSigner } from './framework/plugins/signer/MockSigner.js';
    import { TextNoteTemplate, SetMetadataTemplate } from './framework/templates/nip01.js';
    import { CalendarEventTemplate } from './framework/templates/nip52.js';
    import { EventDeletionTemplate } from './framework/templates/nip09.js';
    import { runEventManagerTests } from './framework/core/EventManager.test.js';

    // Setup
    const templateEngine = new TemplateEngine();
    templateEngine.register('text-note', new TextNoteTemplate());
    templateEngine.register('set-metadata', new SetMetadataTemplate());
    templateEngine.register('calendar-event', new CalendarEventTemplate());
    templateEngine.register('delete-event', new EventDeletionTemplate());

    const signerManager = new SignerManager();
    signerManager.setSigner(new MockSigner('test-pubkey-123'));

    const relayManager = new RelayManager(null, {
      relays: ['wss://relay.damus.io', 'wss://nos.lol']
    });

    const eventManager = new EventManager();
    eventManager.setTemplateEngine(templateEngine);
    eventManager.setSignerManager(signerManager);
    eventManager.setRelayManager(relayManager);

    let currentSubscription = null;
    let lastCreatedEvent = null;

    // Initialize relay manager
    (async () => {
      try {
        await relayManager.initialize();
        log('info', '‚úì RelayManager initialized');
      } catch (error) {
        log('error', '‚úó RelayManager initialization failed: ' + error.message);
      }
    })();

    function log(type, message, outputId = null) {
      const className = type;
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      
      console.log(message);
      
      if (outputId) {
        const output = document.getElementById(outputId);
        if (output) {
          output.innerHTML += `<span class="${className}">${logMessage}</span>\n`;
          output.parentElement.style.display = 'block';
        }
      }
    }

    // Test 1: Unit Tests
    window.runUnitTests = async function() {
      const output = document.getElementById('unit-results');
      const container = document.getElementById('unit-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üß™ Running unit tests...', 'unit-results');
      
      try {
        await runEventManagerTests();
        log('success', '‚úì Unit tests completed - check console for details', 'unit-results');
      } catch (error) {
        log('error', '‚úó Unit tests failed: ' + error.message, 'unit-results');
      }
    };

    // Test 2: Event Creation
    window.testEventCreation = async function() {
      const output = document.getElementById('creation-results');
      const container = document.getElementById('creation-output');
      const display = document.getElementById('event-display');
      output.innerHTML = '';
      display.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üìù Creating and signing event...', 'creation-results');
      
      try {
        const event = await eventManager.createEvent('text-note', {
          content: 'Hello from EventManager! ' + new Date().toISOString()
        });
        
        lastCreatedEvent = event;
        
        log('success', `‚úì Event created and signed: ${event.id}`, 'creation-results');
        log('info', `  Kind: ${event.kind}`, 'creation-results');
        log('info', `  Content: ${event.content}`, 'creation-results');
        log('info', `  Pubkey: ${event.pubkey}`, 'creation-results');
        
        display.innerHTML = `<div class="event-display"><strong>Signed Event:</strong><pre>${JSON.stringify(event, null, 2)}</pre></div>`;
      } catch (error) {
        log('error', '‚úó Failed to create event: ' + error.message, 'creation-results');
      }
    };

    window.testCreateMultiple = async function() {
      const output = document.getElementById('creation-results');
      output.innerHTML = '';
      
      log('info', 'üìù Creating multiple events...', 'creation-results');
      
      try {
        for (let i = 1; i <= 3; i++) {
          const event = await eventManager.createEvent('text-note', {
            content: `Test message ${i}`
          });
          log('success', `‚úì Event ${i} created: ${event.id}`, 'creation-results');
        }
        
        const stats = eventManager.getCacheStats();
        log('info', `üìä Cache contains ${stats.size} events`, 'creation-results');
      } catch (error) {
        log('error', '‚úó Failed: ' + error.message, 'creation-results');
      }
    };

    // Test 3: Publishing
    window.testPublishing = async function() {
      const output = document.getElementById('publish-results');
      const container = document.getElementById('publish-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üì§ Creating and publishing event...', 'publish-results');
      
      try {
        const result = await eventManager.createAndPublish('text-note', {
          content: 'Published via EventManager! ' + new Date().toISOString()
        }, { timeout: 3000 });
        
        log('success', `‚úì Event published: ${result.event.id}`, 'publish-results');
        log('info', `  Success: ${result.successCount}/${result.totalCount} relays`, 'publish-results');
        
        result.results.forEach(r => {
          if (r.success) {
            log('success', `  ‚úì ${r.relay}`, 'publish-results');
          } else {
            log('error', `  ‚úó ${r.relay}: ${r.error?.message || 'Failed'}`, 'publish-results');
          }
        });
      } catch (error) {
        log('error', '‚úó Publishing failed: ' + error.message, 'publish-results');
      }
    };

    window.testPublishExisting = async function() {
      const output = document.getElementById('publish-results');
      output.innerHTML = '';
      
      if (!lastCreatedEvent) {
        log('warning', '‚ö†Ô∏è No event created yet. Create an event first.', 'publish-results');
        return;
      }
      
      log('info', `üì§ Publishing existing event ${lastCreatedEvent.id}...`, 'publish-results');
      
      try {
        const result = await eventManager.publishEvent(lastCreatedEvent, { timeout: 3000 });
        log('success', `‚úì Published to ${result.successCount}/${result.totalCount} relays`, 'publish-results');
      } catch (error) {
        log('error', '‚úó Publishing failed: ' + error.message, 'publish-results');
      }
    };

    // Test 4: Queries
    window.testQuery = async function() {
      const output = document.getElementById('query-results');
      const container = document.getElementById('query-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üîç Querying recent events...', 'query-results');
      
      try {
        const events = await eventManager.queryEvents([
          { kinds: [1], limit: 5 }
        ], { timeout: 5000 });
        
        log('success', `‚úì Found ${events.length} events`, 'query-results');
        
        events.forEach((event, i) => {
          log('info', `  ${i + 1}. ${event.id.substring(0, 16)}... - ${event.content.substring(0, 50)}...`, 'query-results');
        });
      } catch (error) {
        log('error', '‚úó Query failed: ' + error.message, 'query-results');
      }
    };

    window.testQueryFiltered = async function() {
      const output = document.getElementById('query-results');
      output.innerHTML = '';
      
      log('info', 'üîç Querying with filters...', 'query-results');
      
      try {
        const pubkey = await signerManager.getPublicKey();
        const events = await eventManager.queryEvents([
          { kinds: [1], authors: [pubkey], limit: 3 }
        ], { timeout: 5000 });
        
        log('success', `‚úì Found ${events.length} events from ${pubkey.substring(0, 16)}...`, 'query-results');
      } catch (error) {
        log('error', '‚úó Query failed: ' + error.message, 'query-results');
      }
    };

    // Test 5: Subscriptions
    window.testSubscription = function() {
      const output = document.getElementById('sub-results');
      const container = document.getElementById('sub-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      if (currentSubscription) {
        log('warning', '‚ö†Ô∏è Subscription already active', 'sub-results');
        return;
      }
      
      log('info', 'üì° Creating subscription...', 'sub-results');
      
      let count = 0;
      currentSubscription = eventManager.subscribe(
        [{ kinds: [1], limit: 5 }],
        (event) => {
          count++;
          log('success', `‚úì Received event ${count}: ${event.id.substring(0, 16)}...`, 'sub-results');
        }
      );
      
      log('info', `üì° Subscription active: ${currentSubscription.id}`, 'sub-results');
    };

    window.stopSubscription = function() {
      const output = document.getElementById('sub-results');
      
      if (!currentSubscription) {
        log('warning', '‚ö†Ô∏è No active subscription', 'sub-results');
        return;
      }
      
      currentSubscription.close();
      log('info', 'üì° Subscription closed', 'sub-results');
      currentSubscription = null;
    };

    // Test 6: Parsing
    window.testParsing = async function() {
      const output = document.getElementById('parse-results');
      const container = document.getElementById('parse-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üîç Creating and parsing event...', 'parse-results');
      
      try {
        const event = await eventManager.createEvent('text-note', {
          content: 'Test parsing',
          tags: [['t', 'nostr'], ['t', 'test']]
        });
        
        const parsed = eventManager.parseEvent('text-note', event);
        
        log('success', '‚úì Event parsed successfully', 'parse-results');
        log('info', `  Content: ${parsed.content}`, 'parse-results');
        log('info', `  Tags: ${JSON.stringify(parsed.tags)}`, 'parse-results');
        log('info', `  Created: ${new Date(parsed.created_at * 1000).toLocaleString()}`, 'parse-results');
      } catch (error) {
        log('error', '‚úó Parsing failed: ' + error.message, 'parse-results');
      }
    };

    // Test 7: Cache
    window.testCache = async function() {
      const output = document.getElementById('cache-results');
      const container = document.getElementById('cache-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üíæ Testing cache...', 'cache-results');
      
      try {
        // Create events
        const event1 = await eventManager.createEvent('text-note', { content: 'Cache test 1' });
        const event2 = await eventManager.createEvent('text-note', { content: 'Cache test 2' });
        
        // Get from cache
        const cached1 = eventManager.getCachedEvent(event1.id);
        const cached2 = eventManager.getCachedEvent(event2.id);
        
        log('success', `‚úì Event 1 cached: ${cached1 ? 'Yes' : 'No'}`, 'cache-results');
        log('success', `‚úì Event 2 cached: ${cached2 ? 'Yes' : 'No'}`, 'cache-results');
        
        const all = eventManager.getAllCachedEvents();
        log('info', `üìä Total cached events: ${all.length}`, 'cache-results');
      } catch (error) {
        log('error', '‚úó Cache test failed: ' + error.message, 'cache-results');
      }
    };

    window.showCacheStats = function() {
      const stats = eventManager.getCacheStats();
      const container = document.getElementById('cache-stats');
      
      container.innerHTML = `
        <div class="stat-card">
          <h3>Cache Size</h3>
          <div class="value">${stats.size}</div>
        </div>
        <div class="stat-card">
          <h3>Max Size</h3>
          <div class="value">${stats.maxSize}</div>
        </div>
        <div class="stat-card">
          <h3>Utilization</h3>
          <div class="value">${stats.utilizationPercent.toFixed(1)}%</div>
        </div>
      `;
      container.style.display = 'grid';
      
      log('info', `üìä Cache: ${stats.size}/${stats.maxSize} (${stats.utilizationPercent.toFixed(1)}%)`, 'cache-results');
    };

    window.clearEventCache = function() {
      eventManager.clearCache();
      log('success', '‚úì Cache cleared', 'cache-results');
      document.getElementById('cache-stats').style.display = 'none';
    };

    // Test 8: Deletion
    window.testDeletion = async function() {
      const output = document.getElementById('delete-results');
      const container = document.getElementById('delete-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üóëÔ∏è Creating and deleting event...', 'delete-results');
      
      try {
        // Create event
        const event = await eventManager.createEvent('text-note', {
          content: 'This will be deleted'
        });
        log('info', `  Created event: ${event.id}`, 'delete-results');
        
        // Delete event
        const result = await eventManager.deleteEvent(event.id, 'Test deletion', { timeout: 3000 });
        log('success', `‚úì Deletion event created: ${result.event.id}`, 'delete-results');
        log('info', `  Published to ${result.successCount}/${result.totalCount} relays`, 'delete-results');
      } catch (error) {
        log('error', '‚úó Deletion failed: ' + error.message, 'delete-results');
      }
    };

    // Test 9: Event Bus
    window.testEventBusIntegration = async function() {
      const output = document.getElementById('eventbus-results');
      const container = document.getElementById('eventbus-output');
      output.innerHTML = '';
      container.style.display = 'block';
      
      log('info', 'üéØ Testing event bus integration...', 'eventbus-results');
      
      const events = [];
      
      // Listen to events
      const unsubCreated = eventManager.on('event:created', (data) => {
        events.push('created');
        log('success', '‚úì event:created fired', 'eventbus-results');
      });
      
      const unsubSigned = eventManager.on('event:signed', (data) => {
        events.push('signed');
        log('success', '‚úì event:signed fired', 'eventbus-results');
      });
      
      const unsubPublished = eventManager.on('event:published', (data) => {
        events.push('published');
        log('success', '‚úì event:published fired', 'eventbus-results');
      });
      
      try {
        await eventManager.createAndPublish('text-note', {
          content: 'Event bus test'
        }, { timeout: 3000 });
        
        log('info', `üìä Total events fired: ${events.length}`, 'eventbus-results');
      } catch (error) {
        log('error', '‚úó Test failed: ' + error.message, 'eventbus-results');
      } finally {
        unsubCreated();
        unsubSigned();
        unsubPublished();
      }
    };

    // Expose to window
    window.eventManager = eventManager;
    window.templateEngine = templateEngine;
    window.signerManager = signerManager;
    window.relayManager = relayManager;

    console.log('‚úì EventManager test suite loaded');
    console.log('Available globals: eventManager, templateEngine, signerManager, relayManager');
  </script>
</body>
</html>