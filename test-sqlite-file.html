<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQLite File Plugin Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #10b981;
      padding-bottom: 10px;
    }
    h2 {
      color: #666;
      margin-top: 30px;
    }
    .feature-box {
      background: #d1fae5;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #10b981;
    }
    .feature-box h3 {
      margin-top: 0;
      color: #059669;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #10b981;
      border-radius: 4px;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #059669;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #ef4444;
    }
    .danger:hover {
      background: #dc2626;
    }
    .warning {
      background: #f59e0b;
    }
    .warning:hover {
      background: #d97706;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 20px;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #10b981;
      margin-top: 5px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin: 0 5px;
    }
    .badge-filesystem {
      background: #d1fae5;
      color: #059669;
    }
    .badge-localstorage {
      background: #fef3c7;
      color: #d97706;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåç SQLite File Plugin Test - Browser-√úbergreifend!</h1>
    
    <div class="feature-box">
      <h3>üéØ Hauptfeature: Browser-√úbergreifende Datenbank</h3>
      <p><strong>Dieser Plugin funktioniert √ºber mehrere Browser auf dem gleichen Device!</strong></p>
      <ul>
        <li>‚úÖ <strong>Chrome/Edge</strong>: W√§hle einen Ordner ‚Üí Datenbank wird als Datei gespeichert</li>
        <li>‚úÖ <strong>Andere Browser greifen auf dieselbe Datei zu</strong> (wenn gleicher Ordner gew√§hlt)</li>
        <li>‚úÖ <strong>Automatischer Fallback</strong>: localStorage wenn File System API nicht verf√ºgbar</li>
        <li>‚úÖ <strong>Transparent</strong>: Gleiche API wie andere Storage-Plugins</li>
      </ul>
      
      <p><strong>Aktuelle Browser-Unterst√ºtzung:</strong></p>
      <ul>
        <li>Chrome 86+ / Edge 86+: <span class="badge badge-filesystem">File System API</span></li>
        <li>Firefox / Safari: <span class="badge badge-localstorage">localStorage Fallback</span></li>
      </ul>
    </div>

    <div class="test-section">
      <h2>Initialization</h2>
      <p id="browserSupport" style="margin: 10px 0;"></p>
      <button id="initPlugin">Initialize SQLite File Plugin</button>
      <button id="changeDir" disabled>Change Directory</button>
    </div>

    <div class="test-section">
      <h2>Storage Operations</h2>
      <button id="save10">Save 10 Events</button>
      <button id="save100">Save 100 Events</button>
      <button id="queryAll">Query All Events</button>
      <button id="queryKind">Query by Kind</button>
      <button id="clearStorage" class="danger">Clear Storage</button>
    </div>

    <div class="test-section">
      <h2>Browser-√úbergreifender Test</h2>
      <div style="background: #fef3c7; padding: 15px; border-radius: 4px; margin: 10px 0;">
        <strong>Anleitung zum Testen:</strong><br>
        1. Initialisiere Plugin und w√§hle einen Ordner (z.B. Desktop)<br>
        2. Speichere einige Events<br>
        3. √ñffne <strong>einen anderen Browser</strong> (z.B. Edge wenn du Chrome nutzt)<br>
        4. √ñffne diese Seite erneut und initialisiere mit <strong>demselben Ordner</strong><br>
        5. Die Events sollten in beiden Browsern verf√ºgbar sein! üéâ
      </div>
      <button id="testCrossB

rowser" class="warning">Instructions anzeigen</button>
    </div>

    <div class="test-section">
      <h2>Relay Sync</h2>
      <button id="syncFromRelay">Sync from relay-rpi.edufeed.org</button>
    </div>

    <h2>Statistics</h2>
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-label">Storage Mode</div>
        <div class="stat-value" id="storageMode" style="font-size: 14px;">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Events Stored</div>
        <div class="stat-value" id="eventCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Storage Size (KB)</div>
        <div class="stat-value" id="storageSize">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Directory</div>
        <div class="stat-value" id="directory" style="font-size: 14px;">-</div>
      </div>
    </div>

    <h2>Console Output</h2>
    <div id="output"></div>
  </div>

  <script type="module">
    import { StorageManager } from './framework/core/StorageManager.js';
    import { SQLiteFilePlugin } from './framework/plugins/storage/SQLiteFilePlugin.js';
    import { NostrFramework } from './framework/index.js';

    const output = document.getElementById('output');
    let manager = null;
    let plugin = null;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    // Check browser support
    const supportsFileSystem = 'showDirectoryPicker' in window;
    const supportEl = document.getElementById('browserSupport');
    
    if (supportsFileSystem) {
      supportEl.innerHTML = `
        <span class="badge badge-filesystem">‚úì File System Access API unterst√ºtzt</span>
        <br><small>Dieser Browser kann browser-√ºbergreifend auf Dateien zugreifen!</small>
      `;
    } else {
      supportEl.innerHTML = `
        <span class="badge badge-localstorage">‚ö† File System Access API nicht unterst√ºtzt</span>
        <br><small>Automatischer Fallback zu localStorage (browser-gebunden)</small>
      `;
    }

    async function updateStats() {
      if (!manager) return;
      try {
        const stats = await manager.getStats();
        document.getElementById('eventCount').textContent = stats.eventCount;
        document.getElementById('storageSize').textContent = stats.approximateSizeKB;
        
        const mode = stats.storageMode === 'filesystem' ? 
          '<span class="badge badge-filesystem">File System</span>' : 
          '<span class="badge badge-localstorage">localStorage</span>';
        document.getElementById('storageMode').innerHTML = mode;
        
        if (plugin && plugin.isUsingFileSystem() && plugin._dirHandle) {
          document.getElementById('directory').textContent = plugin._dirHandle.name;
          document.getElementById('changeDir').disabled = false;
        } else {
          document.getElementById('directory').textContent = 'N/A';
        }
      } catch (error) {
        log(`Failed to update stats: ${error.message}`, 'error');
      }
    }

    function createTestEvents(count) {
      const events = [];
      const kinds = [1, 3, 7, 30023];
      const authors = ['author1', 'author2', 'author3'];
      
      for (let i = 0; i < count; i++) {
        events.push({
          id: `test_${Date.now()}_${i}_${Math.random()}`,
          kind: kinds[i % kinds.length],
          pubkey: authors[i % authors.length],
          content: `Test event ${i} - ${new Date().toISOString()}`,
          tags: [['t', 'test'], ['p', `user${i % 10}`]],
          created_at: Math.floor(Date.now() / 1000) - (i * 60),
          sig: 'dummy_signature_' + i
        });
      }
      return events;
    }

    // Initialize
    document.getElementById('initPlugin').addEventListener('click', async () => {
      try {
        log('=== Initializing SQLite File Plugin ===', 'info');
        
        if (supportsFileSystem) {
          log('‚úì File System Access API available', 'success');
          log('You will be asked to select a directory...', 'info');
        } else {
          log('‚ö† File System Access API not available, using localStorage', 'warning');
        }
        
        manager = new StorageManager();
        plugin = new SQLiteFilePlugin({ dbName: 'nostr_cross_browser.db' });
        
        const start = performance.now();
        await manager.initialize(plugin);
        const duration = performance.now() - start;
        
        const mode = plugin.getStorageMode();
        log(`‚úì Initialized in ${duration.toFixed(2)}ms`, 'success');
        log(`‚úì Storage mode: ${mode}`, mode === 'filesystem' ? 'success' : 'warning');
        
        if (mode === 'filesystem') {
          log('üéâ Browser-√ºbergreifender Zugriff aktiviert!', 'success');
          log('Die Datenbank ist jetzt als Datei gespeichert', 'info');
        }
        
        await updateStats();
        
        document.getElementById('initPlugin').disabled = true;
      } catch (error) {
        log(`‚úó Initialization failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    // Change directory
    document.getElementById('changeDir').addEventListener('click', async () => {
      try {
        log('Requesting new directory...', 'info');
        await plugin.changeDirectory();
        log('‚úì Directory changed', 'success');
        await updateStats();
      } catch (error) {
        log(`‚úó Failed to change directory: ${error.message}`, 'error');
      }
    });

    // Save operations
    document.getElementById('save10').addEventListener('click', async () => {
      if (!manager) { log('Please initialize plugin first', 'warning'); return; }
      const events = createTestEvents(10);
      log(`Saving ${events.length} events...`, 'info');
      const start = performance.now();
      const count = await manager.save(events);
      const duration = performance.now() - start;
      log(`‚úì Saved ${count} events in ${duration.toFixed(2)}ms`, 'success');
      await updateStats();
    });

    document.getElementById('save100').addEventListener('click', async () => {
      if (!manager) { log('Please initialize plugin first', 'warning'); return; }
      const events = createTestEvents(100);
      log(`Saving ${events.length} events...`, 'info');
      const start = performance.now();
      const count = await manager.save(events);
      const duration = performance.now() - start;
      log(`‚úì Saved ${count} events in ${duration.toFixed(2)}ms`, 'success');
      await updateStats();
    });

    // Query operations
    document.getElementById('queryAll').addEventListener('click', async () => {
      if (!manager) { log('Please initialize plugin first', 'warning'); return; }
      log('Querying all events...', 'info');
      const start = performance.now();
      const events = await manager.query([]);
      const duration = performance.now() - start;
      log(`‚úì Found ${events.length} events in ${duration.toFixed(2)}ms`, 'success');
    });

    document.getElementById('queryKind').addEventListener('click', async () => {
      if (!manager) { log('Please initialize plugin first', 'warning'); return; }
      log('Querying events with kind=1...', 'info');
      const start = performance.now();
      const events = await manager.query([{ kinds: [1] }]);
      const duration = performance.now() - start;
      log(`‚úì Found ${events.length} kind=1 events in ${duration.toFixed(2)}ms`, 'success');
    });

    document.getElementById('clearStorage').addEventListener('click', async () => {
      if (!manager) { log('Please initialize plugin first', 'warning'); return; }
      if (!confirm('Clear all storage? This cannot be undone.')) return;
      log('Clearing storage...', 'warning');
      await manager.clear();
      log('‚úì Storage cleared', 'success');
      await updateStats();
    });

    // Cross-browser test
    document.getElementById('testCrossBrowser').addEventListener('click', () => {
      log('=== Browser-√úbergreifender Test ===', 'info');
      log('', 'info');
      log('Anleitung:', 'info');
      log('1. Klicke "Initialize SQLite File Plugin"', 'info');
      log('2. W√§hle einen Ordner (z.B. Desktop)', 'info');
      log('3. Speichere einige Events (z.B. "Save 10 Events")', 'info');
      log('4. √ñffne EINEN ANDEREN BROWSER auf diesem Device:', 'warning');
      log('   - Wenn du Chrome nutzt ‚Üí √ñffne Edge', 'info');
      log('   - Wenn du Edge nutzt ‚Üí √ñffne Chrome', 'info');
      log('5. √ñffne diese Seite im anderen Browser', 'info');
      log('6. Klicke "Initialize" und w√§hle DENSELBEN Ordner', 'info');
      log('7. Die Events sollten sichtbar sein! üéâ', 'success');
      log('', 'info');
      log('Warum funktioniert das?', 'info');
      log('Die Datenbank wird als echte Datei gespeichert.', 'info');
      log('Beide Browser greifen auf dieselbe Datei zu!', 'success');
    });

    // Relay sync
    document.getElementById('syncFromRelay').addEventListener('click', async () => {
      if (!manager) { log('Please initialize plugin first', 'warning'); return; }
      try {
        log('=== Syncing from relay-rpi.edufeed.org ===', 'info');
        
        const nostr = new NostrFramework({
          relays: ['wss://relay-rpi.edufeed.org'],
          storage: plugin,
          debug: false
        });
        
        await nostr.initialize();
        log('‚úì Framework initialized', 'success');
        
        log('Fetching events from relay...', 'info');
        const result = await nostr.storage.sync({
          filters: [{ kinds: [1], limit: 20 }]
        });
        
        log(`‚úì Sync completed: ${result.saved}/${result.total} events saved`, 'success');
        
        manager = nostr.storage;
        await updateStats();
        
      } catch (error) {
        log(`‚úó Sync failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    // Initialize on load
    log('=== SQLite File Plugin Test Ready ===', 'success');
    log('This plugin supports browser-agnostic storage!', 'info');
    log('Click "Initialize SQLite File Plugin" to begin', 'info');
    log('', 'info');
    
    if (supportsFileSystem) {
      log('‚úì Your browser supports File System Access API', 'success');
      log('Database will be stored as a real file!', 'success');
    } else {
      log('‚ö† Your browser does not support File System Access API', 'warning');
      log('Falling back to localStorage (browser-bound)', 'warning');
    }
  </script>
</body>
</html>