# Nostr Framework

Ein modulares, plugin-basiertes Framework f√ºr Nostr-Client-Entwicklung mit Multi-Provider-Authentifizierung und vollst√§ndiger TypeScript-Unterst√ºtzung.

[![npm version](https://badge.fury.io/js/@johappel%2Fnostr-framework.svg)](https://badge.fury.io/js/@johappel%2Fnostr-framework)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## üöÄ Quick Start

### 1. Installation

#### NPM (f√ºr Projekte)
```bash
# 1. Installiere das Framework
npm install @johappel/nostr-framework

# 2. Installiere nostr-tools als Peer Dependency
npm install nostr-tools@^2.8.1
```

#### CDN (f√ºr schnelle Tests)
```html
<script type="module">
  import { NostrFramework } from 'https://cdn.jsdelivr.net/npm/@johappel/nostr-framework/framework/index.js';
</script>
```

### 2. Basic Usage

```typescript
import { NostrFramework, type FrameworkConfig } from '@johappel/nostr-framework';

const config: FrameworkConfig = {
    relays: ['wss://relay.damus.io', 'wss://nos.lol']
};

const nostr = new NostrFramework(config);
await nostr.initialize();

// Authentifizierung
const identity = await nostr.identity.authenticate('nip07');
console.log('Logged in:', identity.displayName || identity.npub);
```

### 3. Development Setup

For local development:

```bash
git clone https://github.com/johappel/nostr-client.git
cd nostr-client
npm install
```

F√ºr lokale Entwicklung m√ºssen Sie auch `nostr-tools` installieren:
```bash
npm install nostr-tools@^2.8.1
```

### 4. Development Server starten

Verwende VS Code Live Server oder einen anderen lokalen Webserver:

```bash
# VS Code: Rechtsklick auf HTML-Datei ‚Üí "Open with Live Server"
# Oder nutze einen anderen Server, z.B.:
npx serve .
```

### 5. Tests ausf√ºhren

√ñffne eine der Test-Dateien im Browser:

- **NIP-07 Tests**: http://127.0.0.1:5500/test-nip07.html
- **NIP-46 Tests**: http://127.0.0.1:5500/test-nip46.html
- **NSEC Tests**: http://127.0.0.1:5500/test-nsec.html
- **Relay Tests**: http://127.0.0.1:5500/test-relay.html

## üîó Peer Dependencies

Das Framework verwendet `nostr-tools` als **Peer Dependency**. Das bedeutet:

### Vorteile:
- ‚úÖ **Keine Versions-Konflikte** zwischen Ihren und Framework-Abh√§ngigkeiten
- ‚úÖ **Reduzierte Bundle-Gr√∂√üe** - nur eine Version von nostr-tools
- ‚úÖ **Flexibilit√§t** - Sie k√∂nnen die gew√ºnschte Version verwenden
- ‚úÖ **Baum-Sch√ºttelbar** - ungenutzte Teile werden entfernt

### Installation:
```bash
# Framework installieren
npm install @johappel/nostr-framework

# nostr-tools als Ihr Dependency installieren
npm install nostr-tools@^2.8.1
```

### Fehlerbehebung:
Falls Sie einen Fehler wie "Failed to load nostr-tools" erhalten:
```bash
npm install nostr-tools@^2.8.1
```

## üì¶ Implementierte Module

### Core Module (TypeScript)

#### 1. EventBus
- Event-Bus f√ºr Framework-interne Kommunikation
- Observer-Pattern mit TypeScript-Unterst√ºtzung
- Debug-Modus und Typisierte Events

**Datei**: [`framework/core/EventBus.ts`](framework/core/EventBus.ts)

#### 2. IdentityManager
- Zentrale Identity-Verwaltung
- Multi-Provider-Authentifizierung
- Plugin-Registry-System mit Typen
- Session-Persistenz (localStorage)
- Typisierte Events f√ºr Identity-√Ñnderungen

**Datei**: [`framework/core/IdentityManager.ts`](framework/core/IdentityManager.ts)

#### 3. RelayManager
- Multi-Relay-Verbindung mit ConnectionPool
- Automatische Reconnect-Logik
- Event-Filterung und Subscription-Management
- Typisierte Relay-Status und -Events

**Datei**: [`framework/core/RelayManager.ts`](framework/core/RelayManager.ts)

#### 4. EventManager
- Event-Erstellung und -Validierung
- Templates f√ºr verschiedene Event-Typen
- Signierung √ºber verschiedene Provider
- TypeScript Event-Interfaces

**Datei**: [`framework/core/EventManager.ts`](framework/core/EventManager.ts)

#### 5. SignerManager
- Zentrale Signier-Verwaltung
- Multi-Provider-Unterst√ºtzung
- Verschl√ºsselung (NIP-04, NIP-44)
- Typisierte Signer-Capabilities

**Datei**: [`framework/core/SignerManager.ts`](framework/core/SignerManager.ts)

#### 6. StorageManager
- Plugin-basiertes Storage-System
- LocalStorage und SQLite Unterst√ºtzung
- Daten-Persistenz mit TypeScript-Interfaces

**Datei**: [`framework/core/StorageManager.ts`](framework/core/StorageManager.ts)

#### 7. TemplateEngine
- Event-Templates mit Schema-Validierung
- NIP-konforme Event-Erstellung
- Wiederverwendbare typisierte Vorlagen

**Datei**: [`framework/core/TemplateEngine.ts`](framework/core/TemplateEngine.ts)

### Auth Plugins (TypeScript)

#### AuthPlugin (Base Interface)
- TypeScript Base-Klasse f√ºr alle Auth-Plugins
- Definiert typisierte Interface-Methoden
- Vollst√§ndige Kapabilit√§ts-Deklaration

**Datei**: [`framework/plugins/auth/AuthPlugin.ts`](framework/plugins/auth/AuthPlugin.ts)

#### NIP-07 Plugin ‚ú®
- Browser-Extension-Unterst√ºtzung (Alby, nos2x, Flamingo)
- Event-Signierung mit TypeScript-Interfaces
- NIP-04 Verschl√ºsselung/Entschl√ºsselung
- NIP-44 Verschl√ºsselung/Entschl√ºsselung
- Automatische Session-Wiederherstellung
- **Metadaten-Abruf** (displayName, profile info)

**Datei**: [`framework/plugins/auth/Nip07Plugin.ts`](framework/plugins/auth/Nip07Plugin.ts)

#### NIP-46 Plugin üîó
- Remote Signer (Bunker) Unterst√ºtzung
- bunker:// und nostrconnect:// URIs
- Auto-Reconnect mit typed Events
- **Metadaten-Abruf** (displayName, profile info)

**Datei**: [`framework/plugins/auth/Nip46Plugin.ts`](framework/plugins/auth/Nip46Plugin.ts)

#### NSEC Plugin ‚ö†Ô∏è
- **UNSAFE** - Nur f√ºr Testing/Entwicklung
- Lokale nsec/hex Schl√ºssel mit TypeScript-Validation
- Volle NIP-04/NIP-44 Unterst√ºtzung
- Test-Schl√ºssel-Generator
- **Metadaten-Abruf** (displayName, profile info)

**Datei**: [`framework/plugins/auth/NsecPlugin.ts`](framework/plugins/auth/NsecPlugin.ts)

### Konfiguration & Type System

#### Zentrale Config mit TypeScript
- √úberschreibbare Standard-Werte mit Typen
- FrameworkConfig Interface
- Relays, nostr-tools URL, Cache-Dauer
- User-spezifische Konfiguration

**Dateien**: 
- [`framework/config.ts`](framework/config.ts)
- [`framework/types/index.ts`](framework/types/index.ts) - Alle TypeScript-Interfaces

## üíª Verwendung

### Basic Example (TypeScript)

```typescript
import { NostrFramework, type FrameworkConfig } from '@johappel/nostr-framework';

// Initialize mit typisierter Config
const config: FrameworkConfig = {
  relays: ['wss://relay.damus.io', 'wss://nos.lol'],
  debug: true
};

const nostr = new NostrFramework(config);
await nostr.initialize();

// Login mit NIP-07 Extension
const identity = await nostr.identity.authenticate('nip07');
console.log('Logged in:', identity.displayName || identity.npub);

// Event erstellen und signieren √ºber EventManager
const event = await nostr.events.create('text-note', {
  content: 'Hello Nostr!'
});

const result = await nostr.events.publish(event);
console.log('Published:', result);
```

### Mit detaillierter Konfiguration

```typescript
import { NostrFramework, type FrameworkConfig, type StorageConfig } from '@johappel/nostr-framework';

const config: FrameworkConfig = {
  relays: [
    'wss://relay.damus.io',
    'wss://relay.snort.social',
    'wss://nos.lol'
  ],
  metadataCacheDuration: 1800000, // 30 Minuten
  debug: process.env.NODE_ENV === 'development',
  standardTemplates: true,
  storage: {
    type: 'localStorage'
  } as StorageConfig
};

const nostr = new NostrFramework(config);
await nostr.initialize();
```

### Verschiedene Auth-Methoden (TypeScript)

```typescript
import { NostrFramework, type Identity, type AuthCredentials } from '@johappel/nostr-framework';

const nostr = new NostrFramework();
await nostr.initialize();

// NIP-07 (Browser Extension)
const identity1: Identity = await nostr.identity.authenticate('nip07');

// NIP-46 (Remote Bunker)  
const credentials: AuthCredentials = { uri: 'bunker://...' };
const identity2: Identity = await nostr.identity.authenticate('nip46', credentials);

// NSEC (‚ö†Ô∏è UNSAFE - nur f√ºr Tests)
const nsecCredentials: AuthCredentials = { nsec: 'nsec1...' };
const identity3: Identity = await nostr.identity.authenticate('nsec', nsecCredentials);

// Test-Schl√ºssel generieren (‚ö†Ô∏è UNSAFE)
const { NsecPlugin } = await import('@johappel/nostr-framework/plugins/auth/NsecPlugin.js');
const testKey = await NsecPlugin.generateTestKey();
console.log('Test nsec:', testKey.nsec);
```### Mit Event Listeners (TypeScript)

```typescript
import { NostrFramework, type Identity, type FrameworkEvents } from '@johappel/nostr-framework';

const nostr = new NostrFramework();

// Typisierte Event Listeners
nostr.on('identity:login', (data: FrameworkEvents['identity:login']) => {
  console.log('User logged in:', data.identity.displayName);
});

nostr.on('identity:logout', (data: FrameworkEvents['identity:logout']) => {
  console.log('User logged out');
});

nostr.on('identity:changed', (identity: Identity | null) => {
  if (identity) {
    console.log('Identity changed:', identity.displayName || identity.npub);
  } else {
    console.log('Identity cleared');
  }
});

// Framework Events
nostr.on('framework:initialized', () => {
  console.log('Framework ready');
});
```

### Verschl√ºsselung (NIP-04/NIP-44) TypeScript

```typescript
import { NostrFramework, type SignerPlugin } from '@johappel/nostr-framework';

const nostr = new NostrFramework();
await nostr.initialize();

// Typisierter Signer
const signer: SignerPlugin | null = nostr.signer.getSigner();

if (signer) {
  const recipientPubkey = '...';
  const senderPubkey = '...';

  // NIP-04 Encrypt (mit Capability-Check)
  if (signer.nip04Encrypt) {
    const encrypted04: string = await signer.nip04Encrypt(
      recipientPubkey,
      'Secret message'
    );
    
    // NIP-04 Decrypt
    if (signer.nip04Decrypt) {
      const decrypted04: string = await signer.nip04Decrypt(
        senderPubkey,
        encrypted04
      );
    }
  }

  // NIP-44 Encrypt (moderner, mit Capability-Check)
  if (signer.nip44Encrypt) {
    const encrypted44: string = await signer.nip44Encrypt(
      recipientPubkey,
      'Secret message'
    );
    
    // NIP-44 Decrypt
    if (signer.nip44Decrypt) {
      const decrypted44: string = await signer.nip44Decrypt(
        senderPubkey,
        encrypted44
      );
    }
  }

  // Capabilities pr√ºfen
  const capabilities = signer.getCapabilities();
  console.log('Signer capabilities:', capabilities);
}
```

### Metadaten abrufen (TypeScript)

```typescript
import { NostrFramework, type Identity, type NostrProfile } from '@johappel/nostr-framework';

const nostr = new NostrFramework();

// Metadaten werden automatisch geholt und typisiert
const identity: Identity = await nostr.identity.authenticate('nip07');
console.log('Display Name:', identity.displayName);

// Typisierte Metadaten
const profile: NostrProfile | undefined = identity.metadata;
if (profile) {
  console.log('Name:', profile.name);
  console.log('About:', profile.about);
  console.log('Picture:', profile.picture);
  console.log('NIP-05:', profile.nip05);
  console.log('LUD16:', profile.lud16);
}

// Manuell Metadaten aktualisieren
const updatedIdentity: Identity | null = await nostr.identity.refreshMetadata();
if (updatedIdentity?.metadata) {
  console.log('Updated profile:', updatedIdentity.metadata);
}
```

## üß™ Testing

### Live Tests (Browser)

√ñffne diese Dateien direkt im Browser:

- **NIP-07 Tests**: [test-nip07.html](test-nip07.html)
- **NIP-46 Tests**: [test-nip46.html](test-nip46.html)
- **NSEC Tests**: [test-nsec.html](test-nsec.html)
- **Relay Tests**: [test-relay.html](test-relay.html)
- **Storage Tests**: [test-storage.html](test-storage.html)

### Automatische Tests

```javascript
// In Browser Console:
import { runEventBusTests } from './framework/core/EventBus.test.js';
import { runIdentityManagerTests } from './framework/core/IdentityManager.test.js';

const results1 = runEventBusTests();
const results2 = await runIdentityManagerTests();

console.table(results1.tests);
console.table(results2.tests);
```

### Test-Features

Die Test-HTML-Dateien bieten interaktive UIs zum Testen aller Funktionen:
- ‚úÖ Plugin-Registrierung
- ‚úÖ Login/Logout mit allen Auth-Methoden
- ‚úÖ Event-Signierung
- ‚úÖ Verschl√ºsselung (NIP-04/NIP-44)
- ‚úÖ Metadaten-Abruf
- ‚úÖ Relay-Verbindungen
- ‚úÖ Storage-Operationen

## üìÅ Projektstruktur

```
nostr-client/
‚îú‚îÄ‚îÄ framework/
‚îÇ   ‚îú‚îÄ‚îÄ core/                    # Core Module (TypeScript)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventBus.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IdentityManager.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RelayManager.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventManager.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignerManager.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StorageManager.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TemplateEngine.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/               # Auth-Plugins (TypeScript)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthPlugin.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Nip07Plugin.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Nip46Plugin.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NsecPlugin.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage/            # Storage-Plugins
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StoragePlugin.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LocalStoragePlugin.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SQLitePlugin.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ signer/             # Signer-Plugins
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SignerPlugin.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ MockSigner.js
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ templates/              # Event-Templates
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventTemplate.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nip01.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nip09.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nip52.js
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ types/                  # TypeScript Definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # Alle Framework-Typen
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ config.ts              # Zentrale Konfiguration (TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # Main export (TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json         # TypeScript Config
‚îÇ   ‚îî‚îÄ‚îÄ package.json          # Framework Package
‚îÇ
‚îú‚îÄ‚îÄ docs/                      # Dokumentation
‚îú‚îÄ‚îÄ tests/                     # Next.js Test App
‚îú‚îÄ‚îÄ test-*.html               # Browser Test-Dateien
‚îú‚îÄ‚îÄ config.example.html       # Konfigurations-Beispiel
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## üîå Verf√ºgbare Events

### IdentityManager Events

- `identity:initialized` - Manager wurde initialisiert
- `identity:plugin-registered` - Plugin wurde registriert
- `identity:plugin-unregistered` - Plugin wurde entfernt
- `identity:login` - Login erfolgreich
- `identity:logout` - Logout erfolgreich
- `identity:changed` - Identity hat sich ge√§ndert
- `identity:error` - Fehler aufgetreten
- `identity:restored` - Session wurde wiederhergestellt

## üîß NIP-07 Requirements

Das NIP-07 Plugin ben√∂tigt eine installierte Browser-Extension:

- [Alby](https://getalby.com) (empfohlen)
- [nos2x](https://github.com/fiatjaf/nos2x)
- [Flamingo](https://www.flamingo.me)

## üó∫Ô∏è Roadmap

### ‚úÖ Core Module (v1.0.0)
- [x] EventBus
- [x] IdentityManager
- [x] SignerManager
- [x] TemplateEngine
- [x] RelayManager
- [x] EventManager
- [x] StorageManager

### ‚úÖ Auth-Plugins (v1.1.0)
- [x] AuthPlugin Interface
- [x] NIP-07 Plugin (Browser Extensions)
- [x] NIP-46 Plugin (Remote Bunker)
- [x] NSEC Plugin (‚ö†Ô∏è Unsafe - Testing Only)
- [x] Metadaten-Abruf f√ºr alle Plugins

### ‚úÖ Features (v1.1.0)
- [x] Zentrale Konfiguration
- [x] CDN-Unterst√ºtzung
- [x] Metadaten-Caching
- [x] Test-Schl√ºssel-Generator
- [x] Vollst√§ndige NIP-04/NIP-44 Unterst√ºtzung

### ‚úÖ Features (v2.0.0) - TypeScript Migration
- [x] Vollst√§ndige TypeScript-Unterst√ºtzung
- [x] Typisierte Core-Module
- [x] Type-Safe Plugin-Interfaces
- [x] Framework Event Types
- [x] Comprehensive Type Definitions
- [x] IntelliSense & Auto-Completion

### üîÆ Zuk√ºnftige Features
- [ ] Vollst√§ndige Plugin-Migration zu TypeScript
- [ ] Template-System zu TypeScript
- [ ] WordPress API Plugin
- [ ] NIP-05 Verifikation
- [ ] NIP-57 Zap Handling  
- [ ] NIP-28 Group Chat
- [ ] Erweiterte Templates
- [ ] React/Next.js Integration Hooks

### üîÆ Dokumentation
- [x] API-Dokumentation
- [x] Quickstart & Installation
- [x] Konfigurations-Guide
- [ ] Tutorials
- [ ] Beispiel-Projekte



## üêõ Debugging

### Debug-Modus aktivieren

```javascript
const eventBus = new EventBus();
eventBus.setDebugMode(true);

// Alle Events werden jetzt in der Console geloggt
```

### Session pr√ºfen

```javascript
// Session-Daten ansehen
const session = localStorage.getItem('nostr_framework_session');
console.log(JSON.parse(session));

// Session l√∂schen
localStorage.removeItem('nostr_framework_session');
```

## ü§ù Contributing

Beitr√§ge sind willkommen! Das Projekt folgt einem modularen, plugin-basierten Ansatz:

1. Jedes Modul ist unabh√§ngig testbar
2. Plugins implementieren definierte Interfaces
3. Event-Bus f√ºr lose Kopplung
4. Ausf√ºhrliche Tests f√ºr jedes Modul

## üìÑ License

MIT

## üôè Credits

Gebaut mit:
- [nostr-tools](https://github.com/nbd-wtf/nostr-tools) - Nostr protocol utilities
- [Nostr NIPs](https://github.com/nostr-protocol/nips) - Nostr Implementation Possibilities

## üì¶ CDN Link

F√ºr schnelle Tests und Prototyping:

```html
<script type="module">
  import { NostrFramework } from 'https://cdn.jsdelivr.net/npm/@johappel/nostr-framework/framework/index.js';
  
  const nostr = new NostrFramework();
  await nostr.initialize();
  
  const identity = await nostr.authenticate('nip07');
  console.log('Hello from Nostr Framework!', identity.displayName);
</script>
```

**Version**: 2.0.0
**Letztes Update**: Vollst√§ndige TypeScript-Migration, typisierte Core-Module, Framework Event Types