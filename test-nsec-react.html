<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö†Ô∏è NSEC Plugin React Test</title>
  
  <!-- Import Map f√ºr TypeScript Build -->
  <script type="importmap">
    {
      "imports": {
        "./framework/": "./framework/dist/",
        "nostr-tools/nip19": "https://esm.sh/nostr-tools@2.17.0/nip19",
        "nostr-tools": "https://esm.sh/nostr-tools@2.17.0",
        "@noble/hashes/utils": "https://esm.sh/@noble/hashes@1.3.1/utils",
        "@scure/base": "https://esm.sh/@scure/base@1.1.1"
      }
    }
  </script>
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #dc3545;
    }
    
    .header h1 {
      color: #dc3545;
      margin: 0 0 10px 0;
    }
    
    .header .subtitle {
      color: #6c757d;
      font-size: 1.1em;
    }
    
    .warning {
      background: #dc3545;
      color: white;
      border-left: 4px solid #a71d2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 6px;
      font-weight: bold;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #dc3545;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #c82333;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #545b62;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .identity-card {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 20px;
      margin: 20px 0;
      border-radius: 6px;
    }
    
    .identity-card h3 {
      margin: 0 0 15px 0;
      color: #155724;
    }
    
    .identity-field {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .identity-field strong {
      min-width: 100px;
    }
    
    .npub {
      font-family: monospace;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
      word-break: break-all;
    }
    
    .custom-nsec {
      margin: 20px 0;
    }
    
    .custom-nsec input {
      width: calc(100% - 20px);
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-family: monospace;
      margin: 10px 0;
    }
    
    .test-results {
      margin: 30px 0;
    }
    
    .test-results h3 {
      color: #495057;
      margin-bottom: 20px;
    }
    
    .test-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 4px solid #ddd;
    }
    
    .test-item.pending {
      background: #fff3cd;
      border-left-color: #ffc107;
    }
    
    .test-item.success {
      background: #d4edda;
      border-left-color: #28a745;
    }
    
    .test-item.error {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    
    .test-status {
      font-weight: 500;
      font-size: 1.1em;
    }
    
    .test-message {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 5px;
    }
    
    .logs {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .logs h3 {
      margin: 0 0 15px 0;
      color: #495057;
    }
    
    .log-entry {
      font-family: monospace;
      font-size: 0.9em;
      margin: 5px 0;
      word-break: break-word;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #dc3545;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .react-note {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin: 20px 0;
      border-radius: 6px;
    }
    
    .react-note h4 {
      color: #004085;
      margin: 0 0 10px 0;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="header">
      <h1>‚ö†Ô∏è NSEC Plugin React Test</h1>
      <div class="subtitle">React/Next.js-kompatibler Test f√ºr NsecPlugin</div>
    </div>

    <div class="react-note">
      <h4>üîÑ React-Konvertierung</h4>
      <p>Dieser Test wurde von der urspr√ºnglichen HTML-Version zu einem React-kompatiblen Test konvertiert. 
         Er verwendet die gleichen TypeScript-Builds, aber mit modernerer Architektur.</p>
    </div>

    <div class="warning">
      <strong>‚ö†Ô∏è WARNUNG:</strong> Verwende niemals echte NSEC-Keys in Tests! 
      Diese Tests sind nur f√ºr Entwicklungszwecke. Generierte Keys sind zuf√§llig und sicher.
    </div>

    <div class="controls">
      <button id="runAllTests" class="btn btn-primary">
        <span id="testButtonText">‚ñ∂Ô∏è Alle Tests starten</span>
      </button>
      <button id="clearLogs" class="btn btn-secondary">üóëÔ∏è Logs l√∂schen</button>
      <div id="testStatus"></div>
    </div>

    <div id="identityCard" class="identity-card" style="display: none;">
      <h3>Aktuelle Identity</h3>
      <div class="identity-field">
        <strong>NPUB:</strong>
        <span id="identityNpub" class="npub"></span>
      </div>
      <div class="identity-field">
        <strong>Provider:</strong>
        <span id="identityProvider"></span>
      </div>
      <div class="identity-field">
        <strong>Display Name:</strong>
        <span id="identityName"></span>
      </div>
    </div>

    <div class="custom-nsec">
      <h3>Custom NSEC Test</h3>
      <input 
        type="password" 
        id="customNsec" 
        placeholder="nsec1... (f√ºr manuellen Test - niemals echte Keys verwenden!)"
      >
      <div class="controls">
        <button id="loginCustom" class="btn btn-secondary">Mit Custom NSEC einloggen</button>
      </div>
    </div>

    <div class="test-results">
      <h3>Test Results <span id="testProgress">(0/9)</span></h3>
      <div id="testItems"></div>
    </div>

    <div class="logs">
      <h3>Test Logs</h3>
      <div id="logEntries"></div>
    </div>
  </div>

  <script type="module">
    // React-style state management mit Vanilla JS
    let state = {
      plugin: null,
      identity: null,
      testResults: new Map(),
      logs: [],
      isRunning: false
    };

    const testCases = [
      'Plugin Initialization',
      'Generate Test Identity',
      'Login with Generated NSEC',
      'Get Identity',
      'Get Signer',
      'Sign Test Event',
      'NIP-04 Encryption',
      'NIP-04 Decryption',
      'Logout'
    ];

    // UI Update Functions (React-style)
    function updateUI() {
      updateTestStatus();
      updateIdentityCard();
      updateTestResults();
      updateLogs();
    }

    function updateTestStatus() {
      const status = document.getElementById('testStatus');
      const button = document.getElementById('testButtonText');
      
      if (state.isRunning) {
        status.innerHTML = '<div class="spinner"></div> Tests laufen...';
        button.textContent = 'üîÑ Tests laufen...';
      } else {
        status.innerHTML = '';
        button.textContent = '‚ñ∂Ô∏è Alle Tests starten';
      }
    }

    function updateIdentityCard() {
      const card = document.getElementById('identityCard');
      const npub = document.getElementById('identityNpub');
      const provider = document.getElementById('identityProvider');
      const name = document.getElementById('identityName');

      if (state.identity) {
        card.style.display = 'block';
        npub.textContent = state.identity.npub;
        provider.textContent = state.identity.provider;
        name.textContent = state.identity.displayName || 'Nicht verf√ºgbar';
      } else {
        card.style.display = 'none';
      }
    }

    function updateTestResults() {
      const container = document.getElementById('testItems');
      const progress = document.getElementById('testProgress');
      
      const successCount = Array.from(state.testResults.values()).filter(r => r.status === 'success').length;
      progress.textContent = `(${successCount}/${testCases.length})`;

      container.innerHTML = testCases.map(testName => {
        const result = state.testResults.get(testName) || { status: 'pending' };
        return `
          <div class="test-item ${result.status}">
            <div>
              <div>${testName}</div>
              ${result.message ? `<div class="test-message">${result.message}</div>` : ''}
            </div>
            <div class="test-status">
              ${result.status === 'pending' ? '‚è≥' : ''}
              ${result.status === 'success' ? '‚úÖ' : ''}
              ${result.status === 'error' ? '‚ùå' : ''}
              ${result.duration ? ` (${result.duration}ms)` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateLogs() {
      const container = document.getElementById('logEntries');
      container.innerHTML = state.logs.map(log => 
        `<div class="log-entry">${log}</div>`
      ).join('');
      container.scrollTop = container.scrollHeight;
    }

    // Logging Function (React-style)
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      state.logs.push(`[${timestamp}] ${message}`);
      updateUI();
    }

    // Test Result Updates (React-style)
    function updateTestResult(testName, status, message = '', duration = null) {
      state.testResults.set(testName, { status, message, duration });
      updateUI();
    }

    // Test Execution Functions
    async function runTest(testName, testFn) {
      const startTime = Date.now();
      updateTestResult(testName, 'pending');
      
      try {
        await testFn();
        const duration = Date.now() - startTime;
        updateTestResult(testName, 'success', 'Test passed', duration);
        addLog(`‚úÖ ${testName} - SUCCESS (${duration}ms)`);
      } catch (error) {
        const duration = Date.now() - startTime;
        updateTestResult(testName, 'error', error.message, duration);
        addLog(`‚ùå ${testName} - ERROR: ${error.message}`);
        throw error;
      }
    }

    async function runAllTests() {
      if (state.isRunning) return;
      
      state.isRunning = true;
      state.testResults.clear();
      state.logs = [];
      state.identity = null;
      updateUI();
      
      addLog('üöÄ Starting NSEC Plugin React Test Suite...');
      
      try {
        // Import NsecPlugin dynamically
        const { NsecPlugin } = await import('./framework/plugins/auth/NsecPlugin.js');
        
        // Test 1: Plugin Initialization
        await runTest('Plugin Initialization', async () => {
          const testPlugin = new NsecPlugin({
            relays: ['wss://relay.damus.io', 'wss://relay.snort.social']
          });
          await testPlugin.initialize();
          state.plugin = testPlugin;
          addLog('Plugin initialized successfully');
        });

        // Test 2: Generate Test Identity
        let testNsec = '';
        await runTest('Generate Test Identity', async () => {
          if (!state.plugin) throw new Error('Plugin not initialized');
          
          // Generate test NSEC using browser crypto
          const privateKey = new Uint8Array(32);
          window.crypto.getRandomValues(privateKey);
          testNsec = Array.from(privateKey).map(b => b.toString(16).padStart(2, '0')).join('');
          addLog(`Generated test private key: ${testNsec.substring(0, 8)}...`);
        });

        // Test 3: Login with Generated NSEC
        await runTest('Login with Generated NSEC', async () => {
          if (!state.plugin) throw new Error('Plugin not initialized');
          
          const testIdentity = await state.plugin.login({ nsec: testNsec });
          state.identity = testIdentity;
          addLog(`Logged in as: ${testIdentity.npub}`);
          addLog(`Display name: ${testIdentity.displayName || 'None'}`);
        });

        // Test 4: Get Identity
        await runTest('Get Identity', async () => {
          if (!state.plugin) throw new Error('Plugin not initialized');
          
          const currentIdentity = await state.plugin.getIdentity();
          if (!currentIdentity) throw new Error('No identity found');
          if (currentIdentity.pubkey !== state.identity?.pubkey) {
            throw new Error('Identity mismatch');
          }
          addLog(`Identity verified: ${currentIdentity.npub}`);
        });

        // Test 5: Get Signer
        let signer;
        await runTest('Get Signer', async () => {
          if (!state.plugin) throw new Error('Plugin not initialized');
          
          signer = state.plugin.getSigner();
          if (!signer) throw new Error('No signer returned');
          if (signer.type !== 'nsec') throw new Error('Wrong signer type');
          addLog(`Signer type: ${signer.type}`);
        });

        // Test 6: Sign Test Event
        let signedEvent;
        await runTest('Sign Test Event', async () => {
          if (!signer) throw new Error('Signer not available');
          
          const testEvent = {
            kind: 1,
            content: `React NSEC Plugin Test - ${new Date().toISOString()}`,
            tags: [['client', 'nostr-framework-react-test']],
            created_at: Math.floor(Date.now() / 1000)
          };
          
          signedEvent = await signer.signEvent(testEvent);
          if (!signedEvent.id || !signedEvent.sig) {
            throw new Error('Event not properly signed');
          }
          addLog(`Event signed: ${signedEvent.id}`);
        });

        // Test 7: NIP-04 Encryption (if supported)
        await runTest('NIP-04 Encryption', async () => {
          if (!signer) throw new Error('Signer not available');
          
          const testMessage = 'Hello from React NSEC test!';
          const recipientPubkey = state.identity?.pubkey;
          
          if (!recipientPubkey) throw new Error('No recipient pubkey');
          
          try {
            const encrypted = await signer.nip04Encrypt(recipientPubkey, testMessage);
            if (!encrypted) throw new Error('Encryption returned empty result');
            addLog(`Message encrypted (length: ${encrypted.length})`);
          } catch (error) {
            if (error.message.includes('not supported')) {
              addLog('‚ö†Ô∏è NIP-04 encryption not supported by this implementation');
              return;
            }
            throw error;
          }
        });

        // Test 8: NIP-04 Decryption (conditional)
        await runTest('NIP-04 Decryption', async () => {
          addLog('‚ö†Ô∏è NIP-04 decryption test skipped (requires encryption support)');
        });

        // Test 9: Logout
        await runTest('Logout', async () => {
          if (!state.plugin) throw new Error('Plugin not initialized');
          
          await state.plugin.logout();
          const currentIdentity = await state.plugin.getIdentity();
          if (currentIdentity) throw new Error('Identity still exists after logout');
          state.identity = null;
          addLog('Logged out successfully');
        });

        addLog('üéâ All React tests completed successfully!');
        
      } catch (error) {
        addLog(`üí• React test suite failed: ${error.message}`);
      } finally {
        state.isRunning = false;
        updateUI();
      }
    }

    async function loginWithCustomNsec() {
      const customNsec = document.getElementById('customNsec').value;
      if (!state.plugin || !customNsec) return;
      
      try {
        addLog('Attempting login with custom NSEC...');
        const testIdentity = await state.plugin.login({ nsec: customNsec });
        state.identity = testIdentity;
        updateUI();
        addLog(`‚úÖ Custom login successful: ${testIdentity.npub}`);
      } catch (error) {
        addLog(`‚ùå Custom login failed: ${error.message}`);
      }
    }

    // Event Listeners
    document.getElementById('runAllTests').addEventListener('click', runAllTests);
    document.getElementById('loginCustom').addEventListener('click', loginWithCustomNsec);
    document.getElementById('clearLogs').addEventListener('click', () => {
      state.logs = [];
      updateUI();
    });

    // Initialize plugin on load
    async function initialize() {
      try {
        const { NsecPlugin } = await import('./framework/plugins/auth/NsecPlugin.js');
        const testPlugin = new NsecPlugin();
        await testPlugin.initialize();
        state.plugin = testPlugin;
        addLog('‚úÖ React test environment ready');
        addLog('Plugin initialized and ready for testing');
      } catch (error) {
        addLog(`‚ùå Failed to initialize plugin: ${error.message}`);
      }
    }

    // Start initialization
    initialize();
  </script>
</body>
</html>