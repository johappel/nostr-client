<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö†Ô∏è NSEC Plugin Test (UNSAFE)</title>
  
  <!-- Import Map for nostr-tools via CDN -->
  <script type="importmap">
    {
      "imports": {
        "nostr-tools/nip19": "https://esm.sh/nostr-tools@2.17.0/nip19",
        "nostr-tools": "https://esm.sh/nostr-tools@2.17.0",
        "@noble/hashes/utils": "https://esm.sh/@noble/hashes@1.3.1/utils",
        "@scure/base": "https://esm.sh/@scure/base@1.1.1"
      }
    }
  </script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #dc3545;
      border-bottom: 3px solid #dc3545;
      padding-bottom: 10px;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .warning {
      background: #dc3545;
      color: white;
      border-left: 4px solid #a71d2a;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .info {
      background: #D1ECF1;
      border-left: 4px solid #17A2B8;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .success {
      background: #D4EDDA;
      border-left: 4px solid #28A745;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .error {
      background: #F8D7DA;
      border-left: 4px solid #DC3545;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #c82333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    input[type="password"], input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      margin: 10px 0;
    }
    .identity-card {
      background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .identity-card h3 {
      margin-top: 0;
    }
    .identity-card .field {
      margin: 8px 0;
      font-family: monospace;
      font-size: 13px;
    }
    .identity-card .label {
      opacity: 0.8;
      font-size: 11px;
      text-transform: uppercase;
    }
    .console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 10px;
    }
    .console .warn { color: #FFB74D; }
    .console .error { color: #EF5350; }
    .console .success { color: #81C784; }
    .security-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .security-box h3 {
      color: #856404;
      margin-top: 0;
    }
    .security-box ul {
      color: #856404;
    }
  </style>
</head>
<body>
  <h1>‚ö†Ô∏è NSEC Plugin Test (UNSAFE!)</h1>

  <div class="warning">
    <strong>üõë SICHERHEITSWARNUNG üõë</strong><br>
    Diese Authentifizierungsmethode ist UNSICHER und sollte NUR verwendet werden f√ºr:
    <ul style="margin: 10px 0;">
      <li>Testing und Entwicklung</li>
      <li>Wegwerf-Accounts</li>
      <li>Lernzwecke</li>
    </ul>
    <strong>NIEMALS mit Ihrem Haupt-Nostr-Account verwenden!</strong>
  </div>

  <div class="security-box">
    <h3>üîí Warum ist das unsicher?</h3>
    <ul>
      <li>Privater Schl√ºssel wird im Browser-Speicher gehalten</li>
      <li>Optional in localStorage gespeichert</li>
      <li>Sichtbar f√ºr Browser-Extensions</li>
      <li>Anf√§llig f√ºr XSS-Angriffe</li>
    </ul>
    <h3>‚úÖ Empfohlene Alternativen:</h3>
    <ul>
      <li><strong>NIP-07:</strong> Browser Extensions (Alby, nos2x, Flamingo)</li>
      <li><strong>NIP-46:</strong> Remote Signing (Bunker)</li>
    </ul>
  </div>

  <div class="container">
    <h2>Test-Schl√ºssel generieren</h2>
    <div class="info">
      <strong>F√ºr Testzwecke:</strong> Generieren Sie einen neuen Wegwerf-Schl√ºssel:
    </div>
    
    <button class="secondary" onclick="generateTestKey()">üîë Test-Schl√ºssel generieren</button>
    <div id="generate-result"></div>
  </div>

  <div class="container">
    <h2>Login</h2>
    <div class="info">
      Geben Sie Ihren privaten Schl√ºssel ein (nsec1... oder hex Format):
    </div>
    
    <label for="nsec-input">Private Key:</label>
    <input type="password" id="nsec-input" placeholder="nsec1... oder hex (64 Zeichen)">
    
    <div>
      <button id="login-btn" onclick="login()">‚ö†Ô∏è Login (UNSAFE)</button>
      <button id="logout-btn" onclick="logout()" disabled>Logout</button>
    </div>
    
    <div id="identity-display"></div>
  </div>

  <div class="container">
    <h2>Test: Event signieren</h2>
    <button id="sign-btn" onclick="signTestEvent()" disabled>‚úçÔ∏è Test-Event signieren</button>
    <div id="sign-result"></div>
  </div>

  <div class="container">
    <h2>Test: NIP-04 Verschl√ºsselung</h2>
    <input type="text" id="encrypt-text" placeholder="Text to encrypt" style="width: 60%; margin-right: 5px;">
    <button id="encrypt-btn" onclick="testEncryption()" disabled>üîê Verschl√ºsseln</button>
    <div id="encryption-result"></div>
  </div>

  <div class="container">
    <h2>üìã Console Log</h2>
    <button onclick="clearConsole()">üóëÔ∏è Clear</button>
    <div class="console" id="console"></div>
  </div>

  <script type="module">
    import { IdentityManager } from './framework/core/IdentityManager.js';
    import { NsecPlugin } from './framework/plugins/auth/NsecPlugin.js';

    // Global state
    let manager = null;
    let plugin = null;

    // Logging helper
    function log(message, type = 'log') {
      const console = document.getElementById('console');
      if (!console) return;
      
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    // Generate test key
    window.generateTestKey = async function() {
      try {
        log('üîë Generiere Test-Schl√ºssel...', 'log');
        
        const keyPair = await NsecPlugin.generateTestKey();
        
        document.getElementById('generate-result').innerHTML = `
          <div class="success" style="margin-top: 15px;">
            <strong>‚úÖ Test-Schl√ºssel generiert!</strong>
            <div style="margin-top: 15px; font-family: monospace; font-size: 12px;">
              <div style="margin: 10px 0;">
                <strong>Public Key (npub):</strong><br>
                <input type="text" readonly value="${keyPair.npub}"
                       onclick="this.select()"
                       style="width: 100%; cursor: pointer; background: #f8f9fa;">
              </div>
              <div style="margin: 10px 0;">
                <strong>Private Key (nsec) ‚ö†Ô∏è:</strong><br>
                <input type="text" readonly value="${keyPair.nsec}"
                       onclick="this.select()"
                       style="width: 100%; cursor: pointer; background: #fff3cd;">
              </div>
              <div style="margin-top: 15px;">
                <button class="secondary" onclick="useGeneratedKey('${keyPair.nsec}')">
                  ‚Üí Mit diesem Schl√ºssel einloggen
                </button>
                <button class="secondary" onclick="copyToClipboard('${keyPair.nsec}')">
                  üìã nsec kopieren
                </button>
              </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 12px;">
              <strong>‚ö†Ô∏è Wichtig:</strong> Dies ist ein Test-Schl√ºssel!<br>
              - NUR f√ºr Testing verwenden<br>
              - NICHT mit echten Sats verkn√ºpfen<br>
              - Kann von jedem mit Zugang zu dieser Seite gesehen werden
            </div>
          </div>
        `;
        
        log('‚úÖ Test-Schl√ºssel generiert', 'success');
        log(`npub: ${keyPair.npub}`, 'log');
        log('‚ö†Ô∏è WARNUNG: Nur f√ºr Testing verwenden!', 'warn');
      } catch (error) {
        log(`‚ùå Generierung fehlgeschlagen: ${error.message}`, 'error');
        document.getElementById('generate-result').innerHTML = `
          <div class="error">${error.message}</div>
        `;
      }
    };

    // Use generated key
    window.useGeneratedKey = function(nsec) {
      document.getElementById('nsec-input').value = nsec;
      log('‚úÖ Generierter Schl√ºssel in Eingabefeld √ºbernommen', 'success');
      log('‚ö†Ô∏è Klicken Sie auf "Login" um fortzufahren', 'warn');
    };

    // Copy to clipboard
    window.copyToClipboard = async function(text) {
      try {
        await navigator.clipboard.writeText(text);
        log('‚úÖ In Zwischenablage kopiert', 'success');
      } catch (error) {
        log('‚ùå Kopieren fehlgeschlagen - bitte manuell kopieren', 'error');
      }
    };

    // Initialize
    async function init() {
      log('‚ö†Ô∏è WARNUNG: Initialisiere UNSAFE NSEC Plugin...', 'warn');
      log(NsecPlugin.showSecurityWarning(), 'warn');
      
      // Initialize manager and plugin
      manager = new IdentityManager();
      plugin = new NsecPlugin({ rememberKey: true }); // Enable key persistence
      
      try {
        await plugin.initialize();
        log('‚úÖ Plugin initialisiert', 'success');
      } catch (error) {
        log(`‚ö†Ô∏è Plugin-Initialisierung mit Warnung: ${error.message}`, 'warn');
      }
      
      // Register plugin
      try {
        manager.registerPlugin('nsec', plugin);
        await manager.initialize();
        log('‚úÖ Manager initialisiert und Plugin registriert', 'success');

        // Check if already logged in (session restored)
        if (await plugin.isLoggedIn()) {
          try {
            const identity = await manager.authenticate('nsec');
            displayIdentity(identity);
            updateButtonStates(true);
            log('‚ö†Ô∏è Session wiederhergestellt (UNSAFE!)', 'warn');
          } catch (error) {
            log(`‚ö†Ô∏è Session-Wiederherstellung fehlgeschlagen: ${error.message}`, 'warn');
          }
        }
      } catch (error) {
        log(`‚ùå Manager-Initialisierung fehlgeschlagen: ${error.message}`, 'error');
      }
    }

    // Login
    window.login = async function() {
      try {
        const nsec = document.getElementById('nsec-input').value;
        if (!nsec) {
          alert('Bitte privaten Schl√ºssel eingeben!');
          return;
        }

        log('‚ö†Ô∏è Login wird durchgef√ºhrt (UNSAFE!)...', 'warn');
        document.getElementById('login-btn').disabled = true;
        
        const identity = await manager.authenticate('nsec', { nsec });
        
        displayIdentity(identity);
        updateButtonStates(true);
        
        // Clear input for security
        document.getElementById('nsec-input').value = '';
        
        log(`‚ö†Ô∏è Login erfolgreich (UNSAFE!): ${identity.npub}`, 'warn');
      } catch (error) {
        log(`‚ùå Login fehlgeschlagen: ${error.message}`, 'error');
        document.getElementById('identity-display').innerHTML = `
          <div class="error">${error.message}</div>
        `;
      } finally {
        document.getElementById('login-btn').disabled = false;
      }
    };

    // Logout
    window.logout = async function() {
      try {
        log('üîÑ Logout wird durchgef√ºhrt...', 'log');
        
        await manager.logout();
        
        document.getElementById('identity-display').innerHTML = '';
        updateButtonStates(false);
        
        log('‚úÖ Logout erfolgreich - Privater Schl√ºssel gel√∂scht', 'success');
      } catch (error) {
        log(`‚ùå Logout fehlgeschlagen: ${error.message}`, 'error');
      }
    };

    // Sign test event
    window.signTestEvent = async function() {
      try {
        log('‚úçÔ∏è Signiere Test-Event lokal...', 'log');
        
        const signer = manager.getSigner();
        const pubkey = await signer.getPublicKey();
        
        const event = {
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['t', 'unsafe-nsec-test']],
          content: 'Test message from UNSAFE NSEC Plugin!',
          pubkey: pubkey
        };
        
        log(`Event vor Signierung: ${JSON.stringify(event, null, 2)}`, 'log');
        
        const signed = await signer.signEvent(event);
        
        document.getElementById('sign-result').innerHTML = `
          <div class="success">
            <strong>‚úÖ Event erfolgreich signiert (lokal)!</strong>
            <pre style="margin-top: 10px; font-size: 11px;">${JSON.stringify(signed, null, 2)}</pre>
          </div>
        `;
        
        log('‚úÖ Event erfolgreich signiert', 'success');
      } catch (error) {
        log(`‚ùå Signierung fehlgeschlagen: ${error.message}`, 'error');
        document.getElementById('sign-result').innerHTML = `
          <div class="error">${error.message}</div>
        `;
      }
    };

    // Test encryption
    window.testEncryption = async function() {
      try {
        const text = document.getElementById('encrypt-text').value;
        if (!text) {
          alert('Bitte Text eingeben!');
          return;
        }

        log('üîê Verschl√ºssele Text lokal...', 'log');
        
        const signer = manager.getSigner();
        const pubkey = await signer.getPublicKey();
        
        // Encrypt to self for testing
        const encrypted = await signer.nip04Encrypt(pubkey, text);
        
        log('üîì Entschl√ºssele Text lokal...', 'log');
        const decrypted = await signer.nip04Decrypt(pubkey, encrypted);
        
        document.getElementById('encryption-result').innerHTML = `
          <div class="success">
            <strong>‚úÖ Verschl√ºsselung erfolgreich (lokal)!</strong>
            <div style="margin-top: 10px; font-size: 12px;">
              <strong>Original:</strong> ${text}<br>
              <strong>Verschl√ºsselt:</strong> ${encrypted.substring(0, 50)}...<br>
              <strong>Entschl√ºsselt:</strong> ${decrypted}
            </div>
          </div>
        `;
        
        log('‚úÖ Verschl√ºsselung/Entschl√ºsselung erfolgreich', 'success');
      } catch (error) {
        log(`‚ùå Verschl√ºsselung fehlgeschlagen: ${error.message}`, 'error');
        document.getElementById('encryption-result').innerHTML = `
          <div class="error">${error.message}</div>
        `;
      }
    };

    // Display identity
    function displayIdentity(identity) {
      const metadataHtml = identity.metadata ? `
        <div class="field">
          <div class="label">Display Name</div>
          ${identity.displayName || '<em>Nicht gesetzt</em>'}
        </div>
        <div class="field">
          <div class="label">Metadata</div>
          <div style="font-size: 11px; opacity: 0.9;">
            ${identity.metadata.name ? `Name: ${identity.metadata.name}<body>` : ''}
            ${identity.metadata.about ? `About: ${identity.metadata.about}<br>` : ''}
            ${identity.metadata.picture ? `Picture: ${identity.metadata.picture}<br>` : ''}
            ${identity.metadata.nip05 ? `NIP-05: ${identity.metadata.nip05}<br>` : ''}
          </div>
        </div>
      ` : `
        <div class="field">
          <div class="label">Metadata</div>
          <em>Wird geladen...</em>
        </div>
      `;

      document.getElementById('identity-display').innerHTML = `
        <div class="identity-card">
          <h3>‚ö†Ô∏è Connected Identity (UNSAFE)</h3>
          <div class="field">
            <div class="label">Public Key (hex)</div>
            ${identity.pubkey}
          </div>
          <div class="field">
            <div class="label">Public Key (npub)</div>
            ${identity.npub}
          </div>
          <div class="field">
            <div class="label">Provider</div>
            ${identity.provider} - ‚ö†Ô∏è ${identity._warning || 'UNSAFE'}
          </div>
          ${metadataHtml}
          <div class="field">
            <div class="label">Capabilities</div>
            Sign: ${identity.capabilities.canSign ? '‚úÖ' : '‚ùå'} | 
            Encrypt: ${identity.capabilities.canEncrypt ? '‚úÖ' : '‚ùå'} | 
            Decrypt: ${identity.capabilities.canDecrypt ? '‚úÖ' : '‚ùå'}
          </div>
        </div>
      `;
    }

    // Update button states
    function updateButtonStates(isLoggedIn) {
      document.getElementById('login-btn').disabled = isLoggedIn;
      document.getElementById('logout-btn').disabled = !isLoggedIn;
      document.getElementById('sign-btn').disabled = !isLoggedIn;
      document.getElementById('encrypt-btn').disabled = !isLoggedIn;
    }

    // Clear console
    window.clearConsole = function() {
      document.getElementById('console').innerHTML = '';
    };

    // Export for console testing
    window.testNsec = { manager, plugin, log };

    // Auto-init
    init();
  </script>
</body>
</div>