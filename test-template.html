<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TemplateEngine Tests</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      color: #34495e;
      margin-top: 30px;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 5px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      border-radius: 4px;
    }
    .success {
      color: #27ae60;
      font-weight: bold;
    }
    .error {
      color: #e74c3c;
      font-weight: bold;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
      transition: background 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
    button:active {
      transform: scale(0.98);
    }
    pre {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 14px;
    }
    .info {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #3498db;
      margin: 10px 0;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® TemplateEngine Tests</h1>
    
    <div class="info">
      <strong>‚ÑπÔ∏è Info:</strong> Diese Seite testet das TemplateEngine-Modul mit verschiedenen Event-Templates (NIP-01, NIP-52, NIP-09).
    </div>

    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-label">Registrierte Templates</div>
        <div class="stat-value" id="templateCount">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tests Durchgef√ºhrt</div>
        <div class="stat-value" id="testCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tests Erfolgreich</div>
        <div class="stat-value" id="successCount">0</div>
      </div>
    </div>

    <div>
      <button onclick="runAllTests()">üöÄ Alle Tests Ausf√ºhren</button>
      <button onclick="clearResults()">üóëÔ∏è Ergebnisse L√∂schen</button>
      <button onclick="showSchemas()">üìã Schemas Anzeigen</button>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    import { TemplateEngine } from './framework/core/TemplateEngine.js';
    import { TextNoteTemplate, SetMetadataTemplate, CalendarEventTemplate, EventDeletionTemplate } from './framework/templates/index.js';

    // Globale Variablen f√ºr Console-Zugriff
    window.engine = new TemplateEngine();
    window.testResults = [];
    let testCounter = 0;
    let successCounter = 0;

    // Templates registrieren
    console.log('=== Registriere Templates ===');
    engine.register('text-note', new TextNoteTemplate());
    engine.register('set-metadata', new SetMetadataTemplate());
    engine.register('calendar-event', new CalendarEventTemplate());
    engine.register('delete-event', new EventDeletionTemplate());

    // Stats aktualisieren
    document.getElementById('templateCount').textContent = engine.getTemplateNames().length;

    // Test-Funktionen
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const section = document.createElement('div');
      section.className = 'test-section';
      
      const timestamp = new Date().toLocaleTimeString();
      section.innerHTML = `
        <strong>[${timestamp}]</strong> 
        <span class="${type}">${message}</span>
      `;
      
      results.appendChild(section);
      results.scrollTop = results.scrollHeight;
    }

    function logJSON(label, data) {
      const results = document.getElementById('results');
      const section = document.createElement('div');
      section.className = 'test-section';
      
      section.innerHTML = `
        <strong>${label}:</strong>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
      
      results.appendChild(section);
      results.scrollTop = results.scrollHeight;
    }

    function assert(condition, message) {
      testCounter++;
      if (condition) {
        successCounter++;
        log(`‚úÖ ${message}`, 'success');
      } else {
        log(`‚ùå ${message}`, 'error');
        throw new Error(`Assertion failed: ${message}`);
      }
      updateStats();
    }

    function updateStats() {
      document.getElementById('testCount').textContent = testCounter;
      document.getElementById('successCount').textContent = successCounter;
    }

    // Test 1: Template Registration
    window.testRegistration = function() {
      log('=== Test 1: Template Registration ===');
      
      const templates = engine.getTemplateNames();
      logJSON('Registrierte Templates', templates);
      
      assert(templates.length === 4, 'Es sollten 4 Templates registriert sein');
      assert(templates.includes('text-note'), 'text-note sollte registriert sein');
      assert(templates.includes('set-metadata'), 'set-metadata sollte registriert sein');
      assert(templates.includes('calendar-event'), 'calendar-event sollte registriert sein');
      assert(templates.includes('delete-event'), 'delete-event sollte registriert sein');
      
      log('‚úÖ Test 1 bestanden', 'success');
    };

    // Test 2: Build Text Note
    window.testTextNote = function() {
      log('=== Test 2: Build Text Note ===');
      
      const textNote = engine.build('text-note', {
        content: 'Hello Nostr!'
      });
      
      logJSON('Text Note Event', textNote);
      
      assert(textNote.kind === 1, 'Kind sollte 1 sein');
      assert(textNote.content === 'Hello Nostr!', 'Content sollte √ºbereinstimmen');
      assert(Array.isArray(textNote.tags), 'Tags sollte ein Array sein');
      assert(typeof textNote.created_at === 'number', 'created_at sollte eine Zahl sein');
      
      log('‚úÖ Test 2 bestanden', 'success');
    };

    // Test 3: Build Calendar Event
    window.testCalendarEvent = function() {
      log('=== Test 3: Build Calendar Event ===');
      
      const calEvent = engine.build('calendar-event', {
        title: 'Nostr Meetup',
        start: '2024-12-01T18:00:00Z',
        end: '2024-12-01T20:00:00Z',
        location: 'Berlin',
        description: 'Monthly meetup'
      });
      
      logJSON('Calendar Event', calEvent);
      
      assert(calEvent.kind === 31923, 'Kind sollte 31923 sein');
      assert(calEvent.content === 'Monthly meetup', 'Description sollte √ºbereinstimmen');
      assert(Array.isArray(calEvent.tags), 'Tags sollte ein Array sein');
      
      const titleTag = calEvent.tags.find(t => t[0] === 'title');
      assert(titleTag && titleTag[1] === 'Nostr Meetup', 'Title Tag sollte korrekt sein');
      
      const locationTag = calEvent.tags.find(t => t[0] === 'location');
      assert(locationTag && locationTag[1] === 'Berlin', 'Location Tag sollte korrekt sein');
      
      log('‚úÖ Test 3 bestanden', 'success');
    };

    // Test 4: Parse Calendar Event
    window.testParsing = function() {
      log('=== Test 4: Parse Calendar Event ===');
      
      const calEvent = engine.build('calendar-event', {
        title: 'Test Event',
        start: '2024-12-01T18:00:00Z'
      });
      
      // Mock pubkey hinzuf√ºgen f√ºr Parsing
      calEvent.pubkey = 'testpubkey123';
      calEvent.id = 'testeventid123';
      
      const parsed = engine.parse('calendar-event', calEvent);
      
      logJSON('Geparste Daten', parsed);
      
      assert(parsed.title === 'Test Event', 'Titel sollte √ºbereinstimmen');
      assert(parsed.start === '2024-12-01T18:00:00Z', 'Start sollte √ºbereinstimmen');
      assert(parsed.author === 'testpubkey123', 'Author sollte √ºbereinstimmen');
      
      log('‚úÖ Test 4 bestanden', 'success');
    };

    // Test 5: Get Schema
    window.testSchema = function() {
      log('=== Test 5: Get Schema ===');
      
      const schema = engine.getSchema('calendar-event');
      
      logJSON('Calendar Event Schema', schema);
      
      assert(schema.name === 'calendar-event', 'Schema Name sollte √ºbereinstimmen');
      assert(schema.kind === 31923, 'Schema Kind sollte 31923 sein');
      assert(schema.nip === 'NIP-52', 'Schema NIP sollte NIP-52 sein');
      assert(Array.isArray(schema.required), 'Required sollte ein Array sein');
      assert(schema.required.includes('title'), 'Title sollte required sein');
      assert(schema.required.includes('start'), 'Start sollte required sein');
      
      log('‚úÖ Test 5 bestanden', 'success');
    };

    // Test 6: Validation
    window.testValidation = function() {
      log('=== Test 6: Validation ===');
      
      try {
        engine.build('calendar-event', {}); // Fehlende required fields
        log('‚ùå Validation sollte fehlschlagen', 'error');
      } catch (error) {
        log(`‚úÖ Validation funktioniert: ${error.message}`, 'success');
        successCounter++;
      }
      testCounter++;
      updateStats();
      
      log('‚úÖ Test 6 bestanden', 'success');
    };

    // Test 7: Set Metadata
    window.testMetadata = function() {
      log('=== Test 7: Set Metadata ===');
      
      const metadata = engine.build('set-metadata', {
        name: 'Alice',
        about: 'Nostr enthusiast',
        picture: 'https://example.com/alice.jpg',
        nip05: 'alice@nostr.com'
      });
      
      logJSON('Metadata Event', metadata);
      
      assert(metadata.kind === 0, 'Kind sollte 0 sein');
      
      const parsedContent = JSON.parse(metadata.content);
      assert(parsedContent.name === 'Alice', 'Name sollte √ºbereinstimmen');
      assert(parsedContent.about === 'Nostr enthusiast', 'About sollte √ºbereinstimmen');
      
      log('‚úÖ Test 7 bestanden', 'success');
    };

    // Test 8: Delete Event
    window.testDeletion = function() {
      log('=== Test 8: Delete Event ===');
      
      const deletion = engine.build('delete-event', {
        eventIds: ['eventid1', 'eventid2'],
        reason: 'Test deletion'
      });
      
      logJSON('Deletion Event', deletion);
      
      assert(deletion.kind === 5, 'Kind sollte 5 sein');
      assert(deletion.content === 'Test deletion', 'Reason sollte √ºbereinstimmen');
      
      const eventTags = deletion.tags.filter(t => t[0] === 'e');
      assert(eventTags.length === 2, 'Es sollten 2 Event Tags sein');
      
      log('‚úÖ Test 8 bestanden', 'success');
    };

    // Test 9: Query by Kind
    window.testQueryByKind = function() {
      log('=== Test 9: Query by Kind ===');
      
      const kind1Templates = engine.getByKind(1);
      logJSON('Templates mit Kind 1', kind1Templates.map(t => t.name));
      
      assert(kind1Templates.length === 1, 'Es sollte 1 Template mit Kind 1 geben');
      assert(kind1Templates[0].name === 'text-note', 'Template sollte text-note sein');
      
      log('‚úÖ Test 9 bestanden', 'success');
    };

    // Test 10: Query by NIP
    window.testQueryByNip = function() {
      log('=== Test 10: Query by NIP ===');
      
      const nip01Templates = engine.getByNip('NIP-01');
      logJSON('NIP-01 Templates', nip01Templates.map(t => t.name));
      
      assert(nip01Templates.length === 2, 'Es sollten 2 NIP-01 Templates geben');
      
      log('‚úÖ Test 10 bestanden', 'success');
    };

    // Alle Tests ausf√ºhren
    window.runAllTests = function() {
      clearResults();
      testCounter = 0;
      successCounter = 0;
      
      try {
        testRegistration();
        testTextNote();
        testCalendarEvent();
        testParsing();
        testSchema();
        testValidation();
        testMetadata();
        testDeletion();
        testQueryByKind();
        testQueryByNip();
        
        log('üéâ ALLE TESTS BESTANDEN!', 'success');
        log(`‚úÖ ${successCounter}/${testCounter} Tests erfolgreich`, 'success');
      } catch (error) {
        log(`‚ùå Test fehlgeschlagen: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Ergebnisse l√∂schen
    window.clearResults = function() {
      document.getElementById('results').innerHTML = '';
      testCounter = 0;
      successCounter = 0;
      updateStats();
    };

    // Schemas anzeigen
    window.showSchemas = function() {
      clearResults();
      log('=== Alle Template Schemas ===');
      
      const schemas = engine.getAllSchemas();
      logJSON('Schemas', schemas);
      
      Object.entries(schemas).forEach(([name, schema]) => {
        log(`Template: ${name}`, 'info');
        logJSON(`${name} Schema`, schema);
      });
    };

    // Info beim Laden
    console.log('‚úÖ TemplateEngine geladen und bereit!');
    console.log('üìù Verf√ºgbare Templates:', engine.getTemplateNames());
    console.log('üéØ Verwende window.engine f√ºr manuelle Tests');
    console.log('üöÄ Klicke auf "Alle Tests Ausf√ºhren" oder verwende runAllTests() in der Console');
  </script>
</body>
</meta>