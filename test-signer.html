<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SignerManager Tests - Nostr Framework</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h2 {
      color: #667eea;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    #console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1.5rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.25rem 0;
    }

    .log-info { color: #4FC3F7; }
    .log-success { color: #81C784; }
    .log-warning { color: #FFB74D; }
    .log-error { color: #E57373; }
    .log-debug { color: #9575CD; }

    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .status.active {
      background: #81C784;
      color: white;
    }

    .status.inactive {
      background: #E57373;
      color: white;
    }

    .info-box {
      background: #f5f5f5;
      border-left: 4px solid #667eea;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }

    .info-box strong {
      color: #667eea;
    }

    input, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1rem;
      transition: border-color 0.3s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #666;
      font-weight: 600;
    }

    .test-result {
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .test-result.success {
      background: #E8F5E9;
      border: 2px solid #81C784;
      color: #2E7D32;
    }

    .test-result.error {
      background: #FFEBEE;
      border: 2px solid #E57373;
      color: #C62828;
    }

    pre {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê SignerManager Tests</h1>

    <!-- Status Card -->
    <div class="card">
      <h2>üìä System Status</h2>
      <div class="info-box">
        <strong>Signer Status:</strong> <span id="signer-status" class="status inactive">Nicht gesetzt</span><br>
        <strong>Public Key:</strong> <span id="current-pubkey">-</span><br>
        <strong>Capabilities:</strong> <span id="capabilities">-</span>
      </div>
    </div>

    <!-- Setup Card -->
    <div class="card">
      <h2>‚öôÔ∏è Setup</h2>
      <div class="button-group">
        <button onclick="setupSigner()">MockSigner einrichten</button>
        <button onclick="clearSigner()">Signer entfernen</button>
        <button onclick="getPublicKey()">Public Key abrufen</button>
      </div>
    </div>

    <!-- Event Signing Card -->
    <div class="card">
      <h2>‚úçÔ∏è Event Signierung</h2>
      <label for="event-content">Event Content:</label>
      <textarea id="event-content" rows="3" placeholder="Hello Nostr!">Hello Nostr!</textarea>
      
      <label for="event-kind">Event Kind:</label>
      <input type="number" id="event-kind" value="1" min="0">
      
      <div class="button-group">
        <button onclick="signSingleEvent()">Event signieren</button>
        <button onclick="signMultipleEvents()">Mehrere Events signieren</button>
      </div>
      
      <div id="sign-result"></div>
    </div>

    <!-- Encryption Card -->
    <div class="card">
      <h2>üîí Verschl√ºsselung (NIP-04 & NIP-44)</h2>
      
      <label for="recipient-pk">Empf√§nger Public Key:</label>
      <input type="text" id="recipient-pk" value="recipient-pubkey-test">
      
      <label for="message">Nachricht:</label>
      <textarea id="message" rows="2" placeholder="Geheime Nachricht">Secret message for testing</textarea>
      
      <div class="button-group">
        <button onclick="testNip04()">NIP-04 Test</button>
        <button onclick="testNip44()">NIP-44 Test</button>
      </div>
      
      <div id="encryption-result"></div>
    </div>

    <!-- Automated Tests Card -->
    <div class="card">
      <h2>üß™ Automatisierte Tests</h2>
      <div class="button-group">
        <button onclick="runAllTests()">Alle Tests ausf√ºhren</button>
        <button onclick="clearConsole()">Console leeren</button>
      </div>
    </div>

    <!-- Console Output -->
    <div class="card">
      <h2>üìù Console Output</h2>
      <div id="console"></div>
    </div>
  </div>

  <script type="module">
    import { SignerManager } from './framework/core/SignerManager.js';
    import { MockSigner } from './framework/plugins/signer/MockSigner.js';
    import { runSignerManagerTests } from './framework/core/SignerManager.test.js';

    // Global state
    let manager = null;

    // Custom console logging
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function logToPage(message, type = 'info') {
      const consoleDiv = document.getElementById('console');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      consoleDiv.appendChild(entry);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    console.log = (...args) => {
      originalLog(...args);
      logToPage(args.join(' '), 'info');
    };

    console.error = (...args) => {
      originalError(...args);
      logToPage('ERROR: ' + args.join(' '), 'error');
    };

    console.warn = (...args) => {
      originalWarn(...args);
      logToPage('WARNING: ' + args.join(' '), 'warning');
    };

    // Update status display
    function updateStatus() {
      const statusEl = document.getElementById('signer-status');
      const pubkeyEl = document.getElementById('current-pubkey');
      const capsEl = document.getElementById('capabilities');

      if (manager && manager.hasSigner()) {
        statusEl.textContent = 'Aktiv';
        statusEl.className = 'status active';
        
        manager.getPublicKey().then(pk => {
          pubkeyEl.textContent = pk;
        });

        const caps = manager.getCapabilities();
        capsEl.textContent = Object.entries(caps)
          .filter(([k, v]) => v)
          .map(([k]) => k)
          .join(', ');
      } else {
        statusEl.textContent = 'Nicht gesetzt';
        statusEl.className = 'status inactive';
        pubkeyEl.textContent = '-';
        capsEl.textContent = '-';
      }
    }

    // Setup functions
    window.setupSigner = function() {
      try {
        manager = new SignerManager();
        const signer = new MockSigner('test-pubkey-' + Date.now());
        manager.setSigner(signer);
        
        console.log('‚úì SignerManager eingerichtet');
        console.log('‚úì MockSigner gesetzt');
        
        updateStatus();
      } catch (error) {
        console.error('Setup fehlgeschlagen:', error.message);
      }
    };

    window.clearSigner = function() {
      if (manager) {
        manager.clearSigner();
        console.log('‚úì Signer entfernt');
        updateStatus();
      } else {
        console.warn('Kein Manager vorhanden');
      }
    };

    window.getPublicKey = async function() {
      if (!manager || !manager.hasSigner()) {
        console.error('Kein Signer gesetzt');
        return;
      }

      try {
        const pubkey = await manager.getPublicKey();
        console.log('Public Key:', pubkey);
      } catch (error) {
        console.error('Fehler beim Abrufen des Public Keys:', error.message);
      }
    };

    // Event signing functions
    window.signSingleEvent = async function() {
      if (!manager || !manager.hasSigner()) {
        console.error('Kein Signer gesetzt');
        return;
      }

      const content = document.getElementById('event-content').value;
      const kind = parseInt(document.getElementById('event-kind').value);
      const resultDiv = document.getElementById('sign-result');

      try {
        const event = {
          kind,
          content,
          tags: [],
          created_at: Math.floor(Date.now() / 1000)
        };

        console.log('Signiere Event...');
        const signed = await manager.signEvent(event);
        
        console.log('‚úì Event signiert:', signed.id);
        
        resultDiv.className = 'test-result success';
        resultDiv.innerHTML = `
          <strong>‚úì Event erfolgreich signiert!</strong>
          <pre>${JSON.stringify(signed, null, 2)}</pre>
        `;
      } catch (error) {
        console.error('Signierung fehlgeschlagen:', error.message);
        resultDiv.className = 'test-result error';
        resultDiv.innerHTML = `<strong>‚úó Fehler:</strong> ${error.message}`;
      }
    };

    window.signMultipleEvents = async function() {
      if (!manager || !manager.hasSigner()) {
        console.error('Kein Signer gesetzt');
        return;
      }

      const resultDiv = document.getElementById('sign-result');

      try {
        const events = [
          { kind: 1, content: 'Event 1', tags: [], created_at: Math.floor(Date.now() / 1000) },
          { kind: 1, content: 'Event 2', tags: [], created_at: Math.floor(Date.now() / 1000) },
          { kind: 1, content: 'Event 3', tags: [], created_at: Math.floor(Date.now() / 1000) }
        ];

        console.log('Signiere 3 Events...');
        const signed = await manager.signEvents(events);
        
        console.log(`‚úì ${signed.length} Events signiert`);
        
        resultDiv.className = 'test-result success';
        resultDiv.innerHTML = `
          <strong>‚úì ${signed.length} Events erfolgreich signiert!</strong>
          <pre>${JSON.stringify(signed.map(e => ({ id: e.id, kind: e.kind, content: e.content })), null, 2)}</pre>
        `;
      } catch (error) {
        console.error('Signierung fehlgeschlagen:', error.message);
        resultDiv.className = 'test-result error';
        resultDiv.innerHTML = `<strong>‚úó Fehler:</strong> ${error.message}`;
      }
    };

    // Encryption functions
    window.testNip04 = async function() {
      if (!manager || !manager.hasSigner()) {
        console.error('Kein Signer gesetzt');
        return;
      }

      const recipientPk = document.getElementById('recipient-pk').value;
      const message = document.getElementById('message').value;
      const resultDiv = document.getElementById('encryption-result');

      try {
        console.log('NIP-04: Verschl√ºssele Nachricht...');
        const encrypted = await manager.nip04Encrypt(recipientPk, message);
        console.log('NIP-04: Verschl√ºsselt:', encrypted);

        console.log('NIP-04: Entschl√ºssele Nachricht...');
        const decrypted = await manager.nip04Decrypt(recipientPk, encrypted);
        console.log('NIP-04: Entschl√ºsselt:', decrypted);

        if (decrypted === message) {
          resultDiv.className = 'test-result success';
          resultDiv.innerHTML = `
            <strong>‚úì NIP-04 Test erfolgreich!</strong><br>
            Original: ${message}<br>
            Verschl√ºsselt: ${encrypted}<br>
            Entschl√ºsselt: ${decrypted}
          `;
        } else {
          throw new Error('Entschl√ºsselte Nachricht stimmt nicht √ºberein');
        }
      } catch (error) {
        console.error('NIP-04 Test fehlgeschlagen:', error.message);
        resultDiv.className = 'test-result error';
        resultDiv.innerHTML = `<strong>‚úó Fehler:</strong> ${error.message}`;
      }
    };

    window.testNip44 = async function() {
      if (!manager || !manager.hasSigner()) {
        console.error('Kein Signer gesetzt');
        return;
      }

      const recipientPk = document.getElementById('recipient-pk').value;
      const message = document.getElementById('message').value;
      const resultDiv = document.getElementById('encryption-result');

      try {
        console.log('NIP-44: Verschl√ºssele Nachricht...');
        const encrypted = await manager.nip44Encrypt(recipientPk, message);
        console.log('NIP-44: Verschl√ºsselt:', encrypted);

        console.log('NIP-44: Entschl√ºssele Nachricht...');
        const decrypted = await manager.nip44Decrypt(recipientPk, encrypted);
        console.log('NIP-44: Entschl√ºsselt:', decrypted);

        if (decrypted === message) {
          resultDiv.className = 'test-result success';
          resultDiv.innerHTML = `
            <strong>‚úì NIP-44 Test erfolgreich!</strong><br>
            Original: ${message}<br>
            Verschl√ºsselt: ${encrypted}<br>
            Entschl√ºsselt: ${decrypted}
          `;
        } else {
          throw new Error('Entschl√ºsselte Nachricht stimmt nicht √ºberein');
        }
      } catch (error) {
        console.error('NIP-44 Test fehlgeschlagen:', error.message);
        resultDiv.className = 'test-result error';
        resultDiv.innerHTML = `<strong>‚úó Fehler:</strong> ${error.message}`;
      }
    };

    // Automated tests
    window.runAllTests = function() {
      console.log('='.repeat(50));
      console.log('Starte automatisierte Tests...');
      console.log('='.repeat(50));
      runSignerManagerTests();
    };

    window.clearConsole = function() {
      document.getElementById('console').innerHTML = '';
      console.log('Console geleert');
    };

    // Initialize
    console.log('‚úì SignerManager Test-Umgebung geladen');
    console.log('üí° Beginne mit "MockSigner einrichten"');
    
    // Expose for debugging
    window.manager = manager;
  </script>
</body>
</html>